<tool id="compleasm_analyze" name="Compleasm" profile="20.01" version="@TOOL_VERSION@+galaxy0">
    <description>analyze</description>
    <macros>
        <import>macros.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">compleasm</requirement>
    </requirements>

    <stdio>
        <exit_code range="1:" />
    </stdio>
    
    <command><![CDATA[
        #if str($lineage) != '':
            compleasm download '$lineage'
        #end if
        &&
        
        compleasm analyze
        -g '$input'
        --lineage '$lineage'
        -o galaxy
        #if $mode =="busco"
            --mode busco
        #elif $mode =="lite"
            --mode lite
        #end if

        #if str($specified_contigs) != '':
            --specified_contigs '$specified_contigs'
        #end if
        --min_diff $threshold_parameters.min_diff
        --min_length_percent $threshold_parameters.min_length_percent
        --min_complete $threshold_parameters.min_complete
    ]]></command>

    <inputs>
        <param argument="-g" name="input" type="data" format="gff" label="Miniprot output"/>

        <param name="mode" type="select" label="The mode of evaluation">
            <option value="busco" selected="true">BUSCO </option>
            <option value="lite">Lite</option>
        </param>

        <param argument="--specified_contigs" type="text" optional="true" value="" label="Specify the contigs to be evaluated (e.g. chr1 chr2 chr3)" help="If not specified, all contigs will be evaluated">
            <sanitizer invalid_char="">
                <valid initial="string.letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
            <validator type="regex">[0-9a-zA-Z_]+</validator>
        </param>

        <param argument="--lineage" type="text" optional="true" value="" label="Specify the name of the BUSCO lineage to be used" help="e.g. eukaryota, primates, saccharomycetes etc.">
            <sanitizer invalid_char="">
                <valid initial="string.letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
            <validator type="regex">[0-9a-zA-Z_]+</validator>
        </param>

        <section name="threshold_parameters" title="Threshold parameters">
            <param argument="--min_diff" type="float" min="0" max="1" value="0.2" label=" The thresholds for the best matching and second best matching"/>
            <param argument="--min_length_percent" type="float" min="0" max="1" value="0.6" label="The fraction of protein for valid mapping results"/>
            <param argument="--min_complete" type="float" min="0" max="1" value="0.9" label=" The length threshold for complete gene"/>
        </section>

        <param name="outputs" type="select" optional="true" multiple="true" label="Which outputs should be generated">
            <option value="summary" selected="true">summary text</option>
            <option value="full_table_busco">full table busco</option>
            <option value="full_table ">full table</option>
            <option value="gene_marker">gene marker</option>
            <option value="translated_proteins">translated proteins</option>
        </param>
    </inputs>

    <outputs>
        <data name='sum' format='txt' label="${tool.name} on ${on_string}: summary" from_work_dir="galaxy/summary.txt">
            <filter>outputs and 'summary' in outputs</filter>
        </data>
        <data name='full_table_busco' format='tabular' label="${tool.name} on ${on_string}: full table BUSCO" from_work_dir="galaxy/eukaryota*/full_table_busco_format.tsv">
            <filter>outputs and 'full_table_busco' in outputs</filter>
        </data>
        <data name='full_table' format='tabular' label="${tool.name} on ${on_string}: full table" from_work_dir="galaxy/eukaryota*/full_table.tsv">
            <filter>outputs and 'full_table' in outputs</filter>
        </data>
        <data name='gene_marker' format='fasta' label="${tool.name} on ${on_string}: Gene marker" from_work_dir="galaxy/eukaryota*/gene_marker.fasta">
            <filter>outputs and 'gene_marker' in outputs</filter>
        </data>
        <data name='translated_protein' format='fasta' label="${tool.name} on ${on_string}: Translated protein" from_work_dir="galaxy/eukaryota*/translated_protein.fasta">
            <filter>outputs and 'translated_protein' in outputs</filter>
        </data>
    </outputs>

    <tests>
        <test expect_num_outputs="5">
            <param name="input" value="input.fasta"/>
            <param name="mode" value="busco"/>
            <param name="outputs" value="summary, full_table_busco, full_table, gene_marker, translated_protein"/>
            <output name="sum" file="output_analyze/summary.txt" compare="diff" lines_diff="4"/>
            <output name="full_table_busco" file="output_analyze/full_table_busco_format.tsv" compare="diff" lines_diff="4"/>
            <output name="full_table" file="output_analyze/full_table.tsv" compare="diff" lines_diff="4"/>
            <output name="gene_marker" file="output_analyze/gene_marker.fasta" compare="diff" lines_diff="4"/>
            <output name="translated_protein" file="output_analyze/translated_protein.fasta" compare="diff" lines_diff="4"/>
        </test>
    </tests>

    <help><![CDATA[

        compleasm_ The analyze module can be used to evaluate genome completeness based on the miniprot alignment. 

        .. _compleasm: https://github.com/huangnengCSU/compleasm

    ]]></help>
    <expand macro="citation"/>
</tool>
