<tool id="scvelo" name="scvelo" version="@VERSION@+galaxy0" profile="21.01" >
    <description>a library for the analysis of RNA velocity</description>
    <macros>
        <token name="@VERSION@">0.2.3</token>
     </macros>
    <requirements>
        <requirement type="package" version="@VERSION" >scvelo</requirement>
    </requirements>
    <command detect_errors="exit_code" >
<![CDATA[
scvelo --commands
]]>
    </command>
    <inputs>
        <conditional name="do">
            <param name="part" type="select" label="Process"
                   help="'Generate RNA Velocity' must be run first before other processes can run." >
                <option value="preprocess">Generate RNA Velocity</option>
                <option value="general_plots">Produce General Plots"</option>
                <option value="identify_genes">Identify Velocity Genes</option>
                <option value="cycling_progenitors">Identify Cycling Progenitors</option>
                <option value="speed_coherence" >Identify Speed and Coherence</option>
                <option value="graph_pst" >Produce Velocity Graph and Pseudotime</option>
                <option value="paga_velocity">Produce PAGA Velocity</option>
            </param>
            <when value="preprocess">
                <section name="proportion" title="Proportion" >
                    <param name="groupby" type="text" value="clusters"
                           label="GroupBy"  />
                    <param name="layers" type="text" value="spliced#,unspliced,ambiguous"
                           label="Layers" />
                    <param name="highlight" type="text" value="unspliced"
                           label="Highlight"  />
                    <param name="addlabelspie" type="boolean" value="true"
                           label="Show Percentage Labels in Pie Chart?" />
                    <param name="addlabelsbar" type="boolean" value="true"
                           label="Show Percentage Labels in Bar Chart?" />
                    <param name="fontsize" type="integer" min="1" value="8"
                           label="Font Size" />
                </section>
                <section name="filtandnorm" title="Filter and Normalisation" >
                    <param name="mincounts" type="integer" min="1" optional="true"
                           label="Min Counts (spliced)" help="Minimum number of counts required for a gene to pass filtering (spliced)." />
                    <param name="mincountsu" type="integer" min="1" optional="true"
                           label="Min Counts (unspliced)" help="Minimum number of counts required for a gene to pass filtering (unspliced)." />
                    <param name="mincells" type="integer" min="1" optional="true"
                           label="Min Cells (spliced)" help="Minimum number of cells expressed required to pass filtering (spliced)." />
                    <param name="mincellsu" type="integer" min="1" optional="true"
                           label="Min Cells (unspliced)" help="Minimum number of cells expressed required to pass filtering (unspliced)." />
                    <param name="minsharedcounts" type="integer" min="1" optional="true"
                           label="Min Shared Counts" help="Minimum number of counts (both unspliced and spliced) required for a gene." />
                    <param name="minsharedcells" type="integer" min="1" optional="true"
                           label="Min Shared Cells" help="Minimum number of cells (both unspliced and spliced) required for a gene." />
                    <param name="ntopgenes" type="integer" min="1" optional="true"
                           label="Number of genes to keep"  />
                    <param name="retaingenes" type="text" value="" optional="true" 
                           label="Retain Genes" help="List of gene names to be retained independent of thresholds." />
                    <param name="subsethighlyvariable" type="boolean" value="true" checked="true"
                           label="Subset Highly Variable genes" help="Whether to subset highly variable genes or store in the default slot" />
                    <param name="flavor" type="select" label="Flavour"
                           help="Choose the flavor for computing normalized dispersion. If choosing ‘seurat’, this expects non-logarithmized data." >
                        <option value="seurat" selected="true" />
                        <option value="cell_ranger" />
                        <option value="svr" />
                    </param>
                </section>
                <section name="moments" title="Moments" >
                    <param name="nneighbors" type="integer" min="5" value="30" label="Number of Neighbours" />
                    <param name="npcs" type="integer" min="1" label="Number of PCs" optional="true"
                           help="Number of principal components to use. If not specified, the full space is used of a pre-computed PCA, or 30 components are used when PCA is computed internally." />
                    <param name="mode" type="boolean" label="Distance Metrics: Connectivities?" truevalue="connectivities" falsevalue="distances"
                           help="Use the 'connectivities' as the distance metric for moment computation if true. Otherwise 'distances'" />
                    <param name="method" type="select" label="Method to compute Neighbors" >
                        <option value="umap" />
                        <option value="hnsw" />
                        <option value="sklearn" />
                    </param>
                    <param name="usehvg" type="boolean" label="Use highly variable genes only?" checked="true" />
                </section>
                <section name="velocity" title="Velocity" >
                    <param name="vkey" type="text" label="VKey" value="velocity"
                           help="Name under which to refer to the computer velocities for velocity_graph and velocity_embedding" />
                    <param name="fitoffset" type="boolean" label="Fit Offset" checked="false"
                           help="Whether to fit with offset for first order moment dynamics." />
                    <param name="fitoffset2" type="boolean" label="Fit Offset2" checked="false"
                           help="Whether to fit with offset for second order moment dynamics." />
                    <param name="filtergenes" type="boolean" label="Filter Genes" checked="true"
                           help="Whether to remove genes that are not used for further velocity analysis." />
                    <param name="groups" type="text" label="Subset of Groups" value="g1,g2,g3"
                           help="Subset of groups, e.g. [‘g1’, ‘g2’, ‘g3’], to which velocity analysis shall be restricted." />
                    <param name="groupby" type="text"
                           label="list or np.ndarray (default: None)"
                           help="Key of observations grouping to consider." />
                    <param name="groupsforfit" type="text"
                           label="list or np.ndarray (default: None)"
                           help="Subset of groups, e.g. [‘g1’, ‘g2’, ‘g3’], to which steady-state fitting shall be restricted." />
                    <param name="usehvg" type="boolean" checked="true"
                           label="Whether to use highly variable genes only" />
                </section>
                <section name="velocitygraph" title="Velocity Graph" >
                    <param name="vkey" type="text" label="VKey" value="velocity" help="Name of velocity estimates to be used." />
                    <param name="xkey" type="text" label="XKey" value="Ms" help="Layer key to extract count data from." />
                    <param name="tkey" type="text" label="TKey" help="Observation key to extract time data from." optional="true" />
                    <param name="basis" type="text" label="Basis" help="Basis / Embedding to use." optional="true" />
                    <param name="nneighbors" type="integer" label="VelocityGraph Nearest Neighbours" optional="true"
                           help="Use fixed number of neighbors or do recursive neighbor search (if None)." />
                    <param name="nrecurseneighbors" type="integer" value="2" optional="true"
                           label="Number of Recursions for Neighbours Search"
                           help="Number of recursions for neighbors search. Defaults to 2 if mode_neighbors is ‘distances’, and 1 if mode_neighbors is ‘connectivities’." />
                    <param name="randomneighborsatmax" type="integer"
                           label="Number of Iterative Neighbours" optional="true"
                           help="If number of iterative neighbors for an individual cell is higher than this threshold, a random selection of such are chosen as reference neighbors." />
                    <param name="sqrttransform" type="boolean" checked="false"
                           label="Variance-transform?" 
                           help="Whether to variance-transform the cell states changes and velocities before computing cosine similarities." />
                    <param name="genesubset" type="text" value="" optional="true"
                           help="Subset of genes to compute velocity graph on exclusively." />
                    <param name="computeuncertainties" type="boolean" label="Compute Uncertanties?" checked="false"
                           help="Whether to compute uncertainties along with cosine correlation." />
                    <param name="approx" type="boolean" label="Approximation" checked="false"
                           help="If True, first 30 pc’s are used instead of the full count matrix" />
                    <param name="modeneighbors" type="integer" label="KNN graph type is 'distances'? Otherwise 'connectivities'"
                           checked="false" truevalue="distances" falsevalue="connectivities"
                           help="Determines the type of KNN graph used. Options are ‘distances’ or ‘connectivities’. The latter yields a symmetric graph." />
                </section>
                <section name="velocityembedstream" title="Velocity Embed Stream" >
                    <param name="density" type="float" min="0" max="1" value="1" label="Density"
                           help="Amount of velocities to show - 0 none to 1 all" />
                    <param name="scale" type="float" value="1" label="Length of velocities in the embedding." />
                    <param name="basis" type="text" value="umap" label="Key for Embedding" help="Key for embedding. If not specified, use ‘umap’, ‘tsne’ or ‘pca’ (ordered by preference)." />
                    <param name="vkey" type="text" value="" optional="true"
                           label="Key for velocity" help="steady-state ratio to be visualized." />
                    <param name="colors" type="text" value="clusters" optional="true" help="Key for annotations of observations/cells or variables/genes" />
                </section>
                <section name="velocityembed" title="Velocity Embed" >
                    <param name="arrow_length" type="integer" min="1" value="3" label="Arrow Length" help="Length of Arrows" />
                    <param name="arrow_size" type="integer" min="1" value="2" label="Arrow Size" help="Size of Arrows" />
                    <param name="dpi" type="integer" min="1" max="600" value="120" label="DPI" help="Dots Per Inch" />
                </section>
            </when>
            <when value="general_plots">
            </when>
            <when value="identify_genes">
            </when>
            <when value="cycling_progenitors">
            </when>
            <when value="speed_coherence" >
            </when>
            <when value="graph_pst" >
            </when>
            <when value="paga_velocity">
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="res" format="pdf" label="What" />
    </outputs>
    <tests>
        <test>
            <param name="do" value="preprocess" />
            <output name="res" value="test.pdf" />
        </test>
    </tests>
    <help>
        What up
    </help>
    <citations>

    </citations>
</tool>