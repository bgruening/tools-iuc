<tool id="dimet_@EXECUTABLE@" name="dimet_@EXECUTABLE@" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.05">
    <description>
        DIMet is a bioinformatics pipeline for differential analysis of isotopic targeted labeling data.
    </description>
    <macros>
        <token name="@EXECUTABLE@">isotopologues_plot</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
    #import json
    #import re

    mkdir -p '${report.extra_files_path}'/output/${suffix}-isotopologue_proportions_plot/tables &&
    mkdir -p '${report.extra_files_path}'/output/${suffix}-isotopologue_proportions_plot/figures &&
    mkdir -p '${report.extra_files_path}'/raw &&
    mkdir -p '${report.extra_files_path}'/processed &&
    cp -R '$__tool_directory__/config' '${report.extra_files_path}'/config &&
    #if $isotop_abs_file:
        cp '$isotop_abs_file' '${report.extra_files_path}'/raw/isotop_abs.csv &&
    #end if
    #if $isotop_prop_file:
        cp '$isotop_prop_file' '${report.extra_files_path}'/raw/isotop_prop.csv &&
    #end if
    #if $metadata_path:
        cp '$metadata_path' '${report.extra_files_path}'/raw/metadata.csv &&
    #end if
    #set $conds = list()
    #for $co in $conditions:
        $conds.append(re.sub('"', '', str($co)))
    #end for
    #set $metabolites = {}
    #for $cp in $compartments:
        #silent $metabolites[re.sub('"', '', str($cp))]=list()
        #for $met in $metabolites_list:
            $metabolites[re.sub('"', '', str($cp))].append(re.sub('"', '\'', str(re.split('_m', str($met))[0])))
            ###$metabolites[re.sub('"', '', str($cp))].append(re.sub('"', '\'', str($met)))

        #end for
    #end for
    #set $timepoints = list()
    #for $tp in $timepoint:
        $timepoints.append(re.sub('"', '', str($tp)))
    #end for


    HYDRA_FULL_ERROR=1 python python -m dimet
        -cd '${report.extra_files_path}'/config
        -cn general_config_isotopologues_plot
        '++hydra.run.dir='${report.extra_files_path}'/'${suffix}'-isotopologue_proportions_plot'
        '++figure_path=figures'
        '++table_path=tables'
        '+analysis={
            metabolites:${metabolites},
            dataset:{
                _target_:data.DatasetConfig,
                name: "Galaxy DIMet run"
            },
            method:{
                _target_: method.IsotopologueProportionsPlotConfig,
                label: isotopologue_proportions_plot,
                name: "Generate isotopologues proportions plots",
                barcolor: timepoint,
                axisx: condition,
                max_nb_carbons_possible: '${output_options.max_nb_carbons_possible}',
                appearance_separated_time: '${output_options.appearance_separated_time}', ## adds a space between timepoints, conditions stay comparative
                split_plots_by_condition: '${output_options.split_plots_by_condition}', ## prints each condition in independent plots
                x_ticks_text_size: ${output_options.x_ticks_text_size},
                y_ticks_text_size: ${output_options.y_ticks_text_size},
                as_grid: ${output_options.as_grid},
                sharey:${output_options.sharey}
            },
            label: isotopologue_proportions_plot
        }'
        '+analysis.dataset.label='${suffix}''
        '+analysis.timepoints=${timepoints}'
        '+analysis.inner_numbers_size='${output_options.inner_numbers_size}''
        '+analysis.width_each_stack='${output_options.width_each_stack}''
        'analysis.method.height_each_stack='${output_options.height_each_stack}''
        '+analysis.dataset.subfolder='${report.extra_files_path}''
        '+analysis.dataset.conditions=${conds}'
        '+x_text='metabolites''

        #if $metadata_path:
            '++analysis.dataset.metadata=metadata'
        #end if
        #if $isotop_prop_file:
            '++analysis.dataset.isotopologue_proportions=isotop_prop'
        #end if
        #if $isotop_abs_file:
            '++analysis.dataset.isotopologues=isotop_abs'
        #end if

    && cp '${report.extra_files_path}'/'${suffix}'-isotopologue_proportions_plot/figures/*.pdf ./.
    && rm -r '${report.extra_files_path}'/raw
    && rm -r '${report.extra_files_path}'/config

    ]]></command>
    <inputs>
        <param name="isotop_prop_file" type="data" format="tabular" label="Isotopologues proportion abundance file"/>
        <param name="isotop_abs_file" type="data" optional="true" format="tabular" label="Isotopologues absolute abundance file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
        <param name="suffix" type="text" optional="false" label="suffix to add to output files" >
            <sanitizer invalid_char="">
                <valid initial="string.ascii_letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
        </param>
        <param name="conditions" type="select" optional="false" multiple="true"
               label="Browse conditions from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
            <options from_dataset="metadata_path">
                <column name="condition" index="1"/>
                <column name="value" index="1"/>
                <filter type="unique_value" name="condition" column="condition"/>
                <filter type="remove_value" value="condition"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <param name="metabolites_list" type="select" optional="false" multiple="true"
               label="Select Metabolite(s) to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
            <validator type="length" min="1" message="Please enter at max 2 compartments"/>
            <options from_dataset="isotop_prop_file">
                <column name="ID" index="0"/>
                <column name="value" index="0"/>
                <filter type="unique_value" name="ID" column="0"/>
                <filter type="remove_value" value="ID"/>
<!--                <filter type="multiple_splitter" column="0" separator="_m+[0-9]"/>-->
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <param name="timepoint" type="select" optional="false" multiple="true"
               label="Browse timepoint from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
            <options from_dataset="metadata_path">
                <column name="timepoint" index="2"/>
                <column name="value" index="2"/>
                <filter type="unique_value" name="timepoint" column="2"/>
                <filter type="remove_value" value="timepoint"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <param name="compartments" type="select" optional="false" multiple="true"
               label="Browse compartments from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
<!--            <validator type="length" min="1" message="Please enter at min 1 compartments"/>-->
            <options from_dataset="metadata_path">
                <column name="short_comp" index="4"/>
                <column name="value" index="4"/>
                <filter type="unique_value" name="short_comp" column="4"/>
                <filter type="remove_value" value="short_comp"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <section name="output_options" title="Output options">
            <param name="appearance_separated_time" type="boolean" value="false" label="appearance separated time"
                   help="Default value is false."/>
            <param name="split_plots_by_condition" type="boolean" value="false" label="split plots by condition"
                   help="Default value is false."/>
            <param name="as_grid" type="boolean" value="false" label="plot as grid"
                   help="Default value is false."/>
            <param name="sharey" type="boolean" value="false" label="share y axis"
                   help="Default value is false."/>
            <param name="x_ticks_text_size" type="integer" min="1" max="24" value="18" label="xticks text size"
                   help="Default value is 18."/>
            <param name="y_ticks_text_size" type="integer" min="1" max="24" value="18" label="yticks text size"
                   help="Default value is 18."/>
            <param name="height_each_stack" type="float" min="1.0" max="10.0" value="4.6" label="height of each stack"
                   help="Default value is 4.6."/>
            <param name="width_each_stack" type="float" min="0.1" max="5.0" value="3.0" label="width of each stack"
                   help="Default value is 3.0."/>
            <param name="inner_numbers_size" type="integer" min="1" max="20" value="13" label="inner number size"
                   help="Default value is 13."/>
            <param name="max_nb_carbons_possible" type="integer" min="1" max="20" value="12" label="max number carbons possible"
                   help="Default value is 12."/>
        </section>
    </inputs>

    <outputs>
        <data name="report" format="html">
            <discover_datasets pattern="__designation_and_ext__" directory="." visible="true"/>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="metadata_path" ftype="tabular" value="example2_metadata.csv"/>
            <param name="isotop_prop_file" ftype="tabular" value="CorrectedIsotopologues.csv"/>
            <param name="suffix" value="toy1a001"/>
            <param name="conditions" value='"Control","L-Cycloserine"'/>
            <param name="timepoint" value='"T0","T2h"'/>
            <param name="compartments" value='"cell","med"'/>
            <param name="metabolites_list" value="L-Tryptophan_m+0,L-Serine_m+0,L-Asparagine_m+3"/>
            <section name="output_options">
                <param name="appearance_separated_time" value="false"/>
                <param name="split_plots_by_condition" value="false"/>
                <param name="as_grid" value="false"/>
                <param name="sharey" value="false"/>
                <param name="wspace_subfigs" value="0.5"/>
                <param name="max_nb_carbons_possible" value="12"/>
                <param name="width_each_stack" value="3.0"/>
                <param name="height_each_stack" value="3.0"/>
                <param name="x_ticks_text_size" value="18"/>
                <param name="y_ticks_text_size" value="18"/>
            </section>
            <output name="report" file="report.html" count="9"/>
        </test>
    </tests>
    <help><![CDATA[
    dimet @EXECUTABLE@


DIMet isotopologues plot performs stacked-bars figures for visualization of the isotopologues proportions across all given conditions and all/selected time points, for each metabolite. All the (selected) metabolites are processed automatically.

The figures in .pdf format are of publication quality, and as they are vectorial images you can open them and customize aesthetics with a professional image software such as Inkscape, Adobe Illustrator, Sketch,  CorelDRAW, etc.


    **Input data files**

For running DIMet @EXECUTABLE@ you need the following .csv files :

- The **isotopologue proportions** file, and

- The metadata file, a unique file with the description of the samples. This file is compulsory (see section **Metadata File Information**).


The isotopologue proportions file must be organized as a matrix:

- The first column must contain isotopologues IDs that are unique (not repeated) within the file.

- The rest of the columns correspond to the samples

- The rows correspond to the isotopologues

- The values must be tab separated, with the first row containing the sample/column labels.



Example - **Isotopologue proportions**:

    =============== ================== ================== ================== ================== ================== ==================
    ID              **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04** **MCF001089_TD05** **MCF001089_TD06**
    =============== ================== ================== ================== ================== ================== ==================
    2_3-PG_m+0      0.023701408        0.026667837        0.003395407        0.05955            0.034383527        0.12
    2_3-PG_m+1      0.0                0.0                0.0                0.0                0.4                0.12
    2_3-PG_m+2      0.015379329        0.01506            0.017029723        0.35483229         0.54131313         0.743
    2_3-PG_m+3      0.960919263        0.958268099        0.97957487         0.581310816        0.017029723        0.017
    2-OHGLu_m+0     0.972778716        0.960016157        0.238843937        0.234383527        0.9998888          0.015064063
    2-OHGLu_m+1     0.0                0.0                0.0                0.0                0.0001112          0.960919263
    =============== ================== ================== ================== ================== ================== ==================


**Metadata File Information**

Provide a tab-separated file that has the names of the samples in the first column and one header row.
Column names must be exactly in this order:

   name_to_plot
   condition
   timepoint
   timenum
   short_comp
   original_name


Example **Metadata File**:


    ==================== =============== ============= ============ ================ =================
    **name_to_plot**     **condition**   **timepoint** **timenum**  **short_comp**   **original_name**
    -------------------- --------------- ------------- ------------ ---------------- -----------------
    Control_cell_T0-1    Control         T0            0            cell             MCF001089_TD01
    Control_cell_T0-2    Control         T0            0            cell             MCF001089_TD02
    Control_cell_T0-3    Control         T0            0            cell             MCF001089_TD03
    Tumoral_cell_T0-1    Tumoral         T0            0            cell             MCF001089_TD04
    Tumoral_cell_T0-2    Tumoral         T0            0            cell             MCF001089_TD05
    Tumoral_cell_T0-3    Tumoral         T0            0            cell             MCF001089_TD06
    Tumoral_cell_T24-1   Tumoral         T24           24           cell             MCF001089_TD07
    Tumoral_cell_T24-2   Tumoral         T24           24           cell             MCF001089_TD08
    Tumoral_cell_T24-3   Tumoral         T24           24           cell             MCF001090_TD01
    Control_med_T24-1    Control         T24           24           med              MCF001090_TD02
    Control_med_T24-2    Control         T24           24           med              MCF001090_TD03
    Tumoral_med_T24-1    Tumoral         T24           24           med              MCF001090_TD04
    Tumoral_med_T24-2    Tumoral         T24           24           med              MCF001090_TD05
    Control_med_T0-1     Control         T0            0            med              MCF001090_TD06
    Tumoral_med_T0-1     Tumoral         T0            0            med              MCF001090_TD07
    Tumoral_med_T0-2     Tumoral         T0            0            med              MCF001090_TD08
    ==================== =============== ============= ============ ================ =================


The column **original_name** must have the names of the samples as given in your data.

The column **name_to_plot** must have the names as you want them to be (or set identical to original_name if you prefer). To set names that
are meaningful is a better choice, as we will take them to display the results.

The column **timenum** must contain only the numeric part of the timepoint, for example 2,0, 10, 100 (this means, without letters ("T", "t", "s", "h" etc)
nor any other symbol). Make sure these time numbers are in the same units (but do not write the units here!).

The column **short_comp** is an abbreviation, coined by you, for the compartments. This will be used for the results' files names: the longer the
compartments names are, the longer the output files' names! Please pick short and clear abbreviations to fill this column.


**Running the analysis**


You can precise how you want your analysis to be executed, with the parameters:

- **conditions**: the conditions present in your data, exactly in the ORDER you want them to appear in the x axis of each figure.

- **timepoints**: timepoints to include for the figures.

- **width_each_stack** : the desired width (in inches) for the the individual metabolite figure.

- **inner_numbers_size**: by default, the arithmetic mean over the biological replicates for a given isotopologue is displayed in the middle of each bar portion, the default font size is 13.5.  Set to 0 if you do not want to show these values.

There exist hints on use that will guide you, next to the parameters.

The output consist of stacked-bar figures, one by each metabolite, and one legend .pdf file, common to all the produced figures.

**Available data for testing**

You can test our tool with the data from our manuscript https://sandbox.zenodo.org/record/1222142 (the pertinent
files for you are located in the subfolders inside the data folder).
Tou can also use the minimal data examples from https://sandbox.zenodo.org/record/1222659

 ]]>
    </help>
    <expand macro="citations"/>
</tool>