<tool id="dimet_@EXECUTABLE@" name="dimet_@EXECUTABLE@" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.05">
    <description>
        DIMet is a bioinformatics pipeline for differential analysis of isotopic targeted labeling data.
    </description>
    <macros>
        <token name="@EXECUTABLE@">metabologram</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
    #import json
    #import re
    #import os
    #import csv
    #import subprocess
    mkdir -p '${report.extra_files_path}'/output/${suffix}-metabologram/figures &&
    mkdir -p '${report.extra_files_path}'/raw &&
    mkdir -p '${report.extra_files_path}'/processed &&
    mkdir -p '${report.extra_files_path}'/integration_files &&
    cp -R '$__tool_directory__/config' '${report.extra_files_path}'/config &&

    ###set $transcripts  = list()
    ###if $deg_one:
    ##    cp '$deg_one' '${report.extra_files_path}'/integration_files/DEG_comparison1.csv &&
    ##    $transcripts.append(re.sub('"', '', "DEG_comparison1"))
    ##    #set $deg_one_values = os.fsdecode(subprocess.check_output('head -n1 ' + str($deg_one) + '| cut -f' + str($columns_deg_values), shell=True))
    ##    #set $deg_one_id = os.fsdecode(subprocess.check_output('head -n1 ' + str($deg_one) + '| cut -f' + str($columns_deg_id), shell=True))
    ###end if
    ###if $deg_two:
    ##    cp '$deg_two' '${report.extra_files_path}'/integration_files/DEG_comparison2.csv &&
    ##    $transcripts.append(re.sub('"', '', "DEG_comparison2"))
    ##    #set $dam_two_values = os.fsdecode(subprocess.check_output('head -n1 ' + str($deg_two) + '| cut -f' + str($columns_dam_values), shell=True))
    ##    #set $dam_two_id = os.fsdecode(subprocess.check_output('head -n1 ' + str($deg_two) + '| cut -f' + str($columns_dam_id), shell=True))
    ###end if

    #set $transcripts  = list()
    #for $i, $s in enumerate($deg_list)
        #set $cpt = str($i+1)
        cp '${s.input}' '${report.extra_files_path}'/integration_files/DEG_comparison'${cpt}'.csv &&
        $transcripts.append(re.sub('"', '', "DEG_comparison"+str($i+1)))
        #set $deg_one_values = os.fsdecode(subprocess.check_output('head -n1 ' + str($s.input) + '| cut -f' + str($s.valuecol), shell=True))
        #set $deg_one_id = os.fsdecode(subprocess.check_output('head -n1 ' + str($s.input) + '| cut -f' + str($s.idcol), shell=True))
    #end for

    #set $pathways  = {}
    #if $path_kegg_metabolites:
        cp '$path_kegg_metabolites' '${report.extra_files_path}'/integration_files/pathways_kegg_metabolites.csv &&
        #silent $pathways['metabolites']=re.sub('"', '', "pathways_kegg_metabolites")
    #end if

    #if $path_kegg_transcripts:
        cp '$path_kegg_transcripts' '${report.extra_files_path}'/integration_files/pathways_kegg_transcripts.csv &&
        #silent $pathways['transcripts']=re.sub('"', '', "pathways_kegg_transcripts")
    #end if

    #set $statistical_test  = {}
    #set $impute_values  = {}
    #if $abundance_file:
        cp '$abundance_file' '${report.extra_files_path}'/raw/abundance.csv &&
        #silent $statistical_test['abundances']=str($files_to_analyse.abundance_stat_test)
        #silent $impute_values['abundances']=re.sub('"', '', "min")
    #end if
    #if $me_or_frac_contrib_file:
        cp '$me_or_frac_contrib_file' '${report.extra_files_path}'/raw/me_or_frac_contrib.csv &&
        #silent $statistical_test['mean_enrichment']=str($files_to_analyse.meanE_or_fracContrib_stat_test)
        #silent $impute_values['mean_enrichment']=re.sub('"', '', "min")
    #end if
    cp '$metadata_path' '${report.extra_files_path}'/raw/metadata.csv &&


    #set $conds = list()
    #for $co in $conditions:
        $conds.append(re.sub('"', '', str($co)))
    #end for
    #set $tps = list()
    #for $tp in $timepoint:
        $tps.append(re.sub('"', '', str($tp)))
    #end for
    #set $groups = list()
    #for $g in $grouping:
        $groups.append(re.sub('"', '', str($g)))
    #end for

    #set $comparisons = list()
    #if len($conds) > 1:
        #if len($tps) > 0:
            #for $tp in $timepoint:
                #set $ctrl_found=False
                #set $ctrl=""
                #set $comparisons_bis = list()
                #for $co in $conditions:
                    #set $sub_comparisons = list()
                    #if str($co) in ["Control", "control","ctrl"]:
                        #set $ctrl_found=True
                        #set $ctrl=str($co)
                    #else:
                        $sub_comparisons.append(re.sub('"', '', str($co)))
                        $sub_comparisons.append(re.sub('"', '', str($tp)))

                    #end if
                    $comparisons_bis.append($sub_comparisons)
                #end for

                #if $ctrl_found:
                    $sub_comparisons.append(str($ctrl))
                    $sub_comparisons.append(str($tp))
                    $comparisons_bis.append($sub_comparisons)
                #end if

                $comparisons.append($comparisons_bis)
            #end for
        #else
            ##set $comparisons_bis = list()
            #for $co in $conditions:
                $comparisons.append(re.sub('"', '', str($co)))
            #end for
            ###$comparisons.append($comparisons_bis)
        #end if

    #else
        #if len($tps) > 1:
            #for $co in $conditions:
                #set $comparisons_bis = list()
                #for $tp in $timepoint:
                    #set $sub_comparisons = list()
                    $sub_comparisons.append(re.sub('"', '', str($co)))
                    $sub_comparisons.append(re.sub('"', '', str($tp)))
                    $comparisons_bis.append($sub_comparisons)
                #end for
                $comparisons.append($comparisons_bis)
            #end for
        #end if


    #end if



    HYDRA_FULL_ERROR=1 python -m dimet
	-cd '${report.extra_files_path}'/config
	-cn general_config_metabologram
	'++figure_path=figures'
	'++table_path=tables'
	'++hydra.run.dir='${report.extra_files_path}'/'${suffix}'-metabologram'
	'++analysis={
		dataset:{
			_target_: data.DataIntegrationConfig,
			label: example4,
			name: "I am a synthetic data example",
			subfolder: '${report.extra_files_path}',
			metadata: metadata,
			conditions:${conds},
    	    pathways: ${pathways}
		},
		method:{
			_target_: method.MetabologramIntegrationConfig,
			label: "metabologram",
			name: "Perform data integration via metabologram visualization",
			grouping:$groups,
			impute_values:${impute_values},
			abs_values_scale_color_bar: {transcripts: null, metabolites:null},
			qualityDistanceOverSpan: -0.3,
			correction_method: ${correction_method},
			colors_divergent_palette: ['darkcyan', 'white', 'orangered'],
			edge_color: ['black','black'],
			line_width:['1','1.2'],
			display_label_and_value: true,
			font_size: ${output_options.font_size},
			fig_width: ${output_options.fig_width},
			fig_height: ${output_options.fig_height},
			statistical_test:${statistical_test}
		},
		statistical_test:${statistical_test},
		columns_metabolites: {ID: metabolite, values: log2FC},
		columns_transcripts: {ID: ${deg_one_id}, values: ${deg_one_values}},
		compartment: cell,
		label: metabologram
	}'
	'+analysis.dataset.transcripts=${transcripts}'
	'+analysis.comparisons=${comparisons}'
    #if $abundance_file:
        '++analysis.dataset.abundances=abundance'
    #end ifs
    #if $me_or_frac_contrib_file:
        '++analysis.dataset.mean_enrichment=me_or_frac_contrib'
    #end if



    && cp '${report.extra_files_path}'/'${suffix}'-metabologram/figures/*.pdf ./.
    && rm -r '${report.extra_files_path}'/raw
    && rm -r '${report.extra_files_path}'/config


    ]]></command>
    <inputs>
        <param name="abundance_file" type="data" optional="true" format="tabular" label="Metabolite abundance file"/>
        <param name="me_or_frac_contrib_file" optional="true" type="data" format="tabular" label="Mean enrichment or fraction contribution file"/>
<!--        <param name="deg_one" type="data" format="tabular" label="Deregulated genes set 1"/>-->
<!--        <param name="deg_two" type="data" format="tabular" optional="true" label="Deregulated genes set 2"/>-->
        <repeat name="deg_list" title="Deregulated gene set">
            <param name="input" type="data" format="tabular" label="Deregulated genes set"/>
            <param name="idcol" type="data_column" data_ref="input" label="Column for id" use_header_names="true"/>
            <param name="valuecol" type="data_column" data_ref="input" label="Column for values" use_header_names="true"/>
        </repeat>
        <param name="path_kegg_metabolites" type="data" format="tabular" label="Pathways kegg metabolites file"/>
        <param name="path_kegg_transcripts" type="data" format="tabular" label="Pathways kegg transcripts file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
        <param name="suffix" type="text" optional="false" label="suffix to add to output files" >
            <sanitizer invalid_char="">
                <valid initial="string.ascii_letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
        </param>

        <param name="conditions" type="select" optional="true" multiple="true" label="Browse conditions from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
            <options from_dataset="metadata_path">
                <column name="condition" index="1"/>
                <column name="value" index="1"/>
                <filter type="unique_value" name="condition" column="condition"/>
                <filter type="remove_value" value="condition"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
        <param name="timepoint" type="select" optional="true" multiple="true" label="Browse timepoint from metadata file (2 Max.)">
            <options from_dataset="metadata_path">
                <column name="timepoint" index="2"/>
                <column name="value" index="2"/>
                <filter type="unique_value" name="timepoint" column="2"/>
                <filter type="remove_value" value="timepoint"/>
                <filter type="sort_by" name="timepoint" column="1"/>
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="grouping" type="select"  optional="false" multiple="true" label="Browse group to compare">
            <option value="condition" selected="true">condition</option>
            <option value="timepoint">timepoint</option>
        </param>
        <param name="correction_method" type="select" value="bonferroni" display="radio" label="Select multiple test correction to apply" help="Please enter at max 1 method">
                <option value="bonferroni">bonferroni</option>
                <option value="holm-sidak">holm-sidak</option>
                <option value="holm">holm</option>
                <option value="simes-hochberg">simes-hochberg</option>
                <option value="hommel">hommel</option>
                <option value="fdr_bh">fdr_bh</option>
                <option value="fdr_by">fdr_by</option>
                <option value="fdr_tsbh">fdr_tsbh</option>
                <option value="fdr_tsbky">fdr_tsbky</option>
        </param>
        <section name="files_to_analyse">
            <param name="abundance_stat_test" type="select" value="Tt" display="radio" label="Select statistical to apply to abundance file" help="Please enter at max 1 statistical test by file">
                <option value="Tt">t-test</option>
                <option value="MW">Mann Whitney</option>
                <option value="KW">Kruskall Wallis</option>
                <option value="ranksum">Wilcoxon's rank sum test</option>
                <option value="Wcox">Wilcoxon signed-rank test</option>
                <option value="BrMu">Brunner-Munzel test</option>
                <option value="prm-scipy">permutations test</option>
                <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
            </param>

            <param name="meanE_or_fracContrib_stat_test" type="select" value="Tt"  display="radio" label="Select statistical to apply" help="Please enter at max 1 statistical test by file">
                <option value="Tt">t-test</option>
                <option value="MW">Mann Whitney</option>
                <option value="KW">Kruskall Wallis</option>
                <option value="ranksum">Wilcoxon's rank sum test</option>
                <option value="Wcox">Wilcoxon signed-rank test</option>
                <option value="BrMu">Brunner-Munzel test</option>
                <option value="prm-scipy">permutations test</option>
                <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
            </param>
        </section>
        <section name="output_options" title="Output options">
            <param name="feature_color" type="color" multiple="true" label="Default feature color" value="#ff00ff">
                    <sanitizer>
                        <valid initial="string.ascii_letters,string.digits">
                            <add value="#" />
                        </valid>
                    </sanitizer>
            </param>
            <param name="fig_width" type="integer" min="5" max="20" value="7" label="width of figures"
                   help="Default value is 7."/>
            <param name="fig_height" type="integer" min="5" max="20" value="7" label="heigt of each figure"
                   help="Default value is 7."/>
            <param name="font_size" type="integer" min="1" max="20" value="12" label=" figure font size"
                   help="Default value is 12."/>
        </section>
    </inputs>

    <outputs>
        <data name="report" format="html">
            <discover_datasets pattern="__designation_and_ext__" directory="." visible="true" />
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input" ftype="tabular" value="DEG_comparison_1.csv"/>
            <param name="idcol" ftype="integer" value="2"/>
            <param name="valuecol" ftype="integer" value="3"/>
            <param name="path_kegg_metabolites" ftype="tabular" value="pathways_kegg_metabolites.csv"/>
            <param name="path_kegg_transcripts" ftype="tabular" value="pathways_kegg_transcripts.csv"/>
            <param name="abundance_file" ftype="tabular" value="rawAbundances.csv"/>
            <param name="metadata_path" ftype="tabular" value="example2_metadata.csv"/>
            <param name="suffix" value="toy1a001"/>
            <section name="files_to_analyse">
                <param name="abundance_stat_test" value="prm-scipy"/>
                <param name="meanE_or_fracContrib_stat_test" value="ranksum"/>
                <param name="isotopologue_prop_stat_test" value="disfit"/>
                <param name="isotopologue_abs_stat_test" value="disfit"/>
            </section>
            <param name="conditions" value='"Control","L-Cycloserine"'/>
            <param name="timepoint" value='"T0"'/>
            <param name="grouping" value="condition,timepoint"/>
            <output name="report" file="report.html" count="5"/>
        </test>
    </tests>
    <help><![CDATA[
    dimet @EXECUTABLE@

    **Counts Data**

This tool requires 5 tab-delimmited files as inputs.The measure's files can be input as count matrices (one sample per column). The rows correspond to metabolites, and columns correspond to the counts for the samples. Values must be tab separated, with the first row containing the sample/column labels. The first column must contain Metabolite IDs that are unique (not repeated) within the counts file.

Regarding the measure's files, they consist of 4 tab-delimited .csv files, one by type of measure:

- The **metabolites** abundances file
- The **labelled** (carbon) fractional contributions or mean enrichment
- The **isotopologues** proportions file
- The **isotopologues** absolute values files (optional)

For the metadata file see section below.

**Factor Metabolites Abundances Matrix**

You can also run DIMet if you have all except the last type of measure.

Example - **Metabolites Abundances Matrix**:

    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    EntrezID        **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04** **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04**
    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    Fru6P           71                 73                 69                 36                 22                 28                 28                 21
    FruBP           3                  4                  2                  4                  0                  1                  1                  3
    Glc6P           2310               2142               2683               1683               2068               2172               2172               2672
    Gly3P           3                  1                  2                  1                  5                  3                  3                  2
    IsoCit          9                  11                 4                  13                 6                  10                 10                 32
    =============== ================== ================== ================== ================== ================== ================== ================== ==================

Example - **labelled (carbon) fractional contributions or mean enrichment**:

    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    EntrezID        **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04** **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04**
    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    Fru6P           0.66               0.66               0.06               0.06               22                 28                 28                 21
    FruBP           0.06               0.66               0.06               0.06               0                  1                  1                  3
    Glc6P           0.06               0.66               2683               0.06               2068               2172               2172               2672
    Gly3P           0.06               0.06               0.06               1                  5                  3                  3                  2
    IsoCit          0.06               11                 4                  13                 6                  10                 10                 32
    =============== ================== ================== ================== ================== ================== ================== ================== ==================


Example - **Metabolites Abundances Matrix**:

    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    EntrezID        **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04** **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04**
    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    Fru6P           71                 73                 69                 36                 22                 28                 28                 21
    FruBP           3                  4                  2                  4                  0                  1                  1                  3
    Glc6P           2310               2142               2683               1683               2068               2172               2172               2672
    Gly3P           3                  1                  2                  1                  5                  3                  3                  2
    IsoCit          9                  11                 4                  13                 6                  10                 10                 32
    =============== ================== ================== ================== ================== ================== ================== ================== ==================


Example - **Metabolites Abundances Matrix**:

    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    EntrezID        **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04** **MCF001089_TD01** **MCF001089_TD02** **MCF001089_TD03** **MCF001089_TD04**
    =============== ================== ================== ================== ================== ================== ================== ================== ==================
    Fru6P           71                 73                 69                 36                 22                 28                 28                 21
    FruBP           3                  4                  2                  4                  0                  1                  1                  3
    Glc6P           2310               2142               2683               1683               2068               2172               2172               2672
    Gly3P           3                  1                  2                  1                  5                  3                  3                  2
    IsoCit          9                  11                 4                  13                 6                  10                 10                 32
    =============== ================== ================== ================== ================== ================== ================== ================== ==================


**Metadata File Information**

provide a tab-separated file that has the names of the samples in the first column and one header row. The sample names must be the same as the names in the columns of the count matrix.
The second column should contain the primary factor levels (e.g. WT, Mut) with optional additional columns for any secondary factors e.g Batch.

Example **Metadata File**:

    ================= ================== ============= =========== ============= ==============
    **original_name** **name_to_plot**   **timepoint** **timenum** **condition** **short_comp**
    ----------------- ------------------ ------------- ----------- ------------- --------------
    MCF001089_TD01    Control_cell_T0-1  T0            0           Control       cell
    MCF001089_TD02    Control_cell_T0-2  T0            0           Control       cell
    MCF001090_TD01    Control_cell_T0-1  T0            0           Control       med
    MCF001090_TD02    Control_cell_T0-2  T0            0           Control       med
    MCF001089_TD03    Tumoral_cell_T0-3  T0            0           Tumoral       cell
    MCF001089_TD04    Tumoral_cell_T0-4  T0            0           Tumoral       cell
    MCF001090_TD03    Tumoral_med_T0-4   T0            0           Tumoral       med
    MCF001090_TD04    Tumoral_med_T0-5   T0            0           Tumoral       med
    MCF001089_TD01    Control_cell_T24-1 T24           24          Control       cell
    MCF001089_TD02    Control_cell_T24-2 T24           24          Control       cell
    MCF001090_TD01    Control_med_T24-1  T24           24          Control       med
    MCF001090_TD02    Control_med_T24-2  T24           24          Control       med
    MCF001089_TD03    Tumoral_cell_T24-3 T24           24          Tumoral       cell
    MCF001089_TD04    Tumoral_cell_T24-4 T24           24          Tumoral       cell
    MCF001090_TD03    Tumoral_med_T24-3  T24           24          Tumoral       med
    MCF001090_TD04    Tumoral_med_T24-4  T24           24          Tumoral       med
    ================= ================== ============= =========== ============= ==============

Column names in metadata must be exactly in this order:

    original_name
    name_to_plot
    timepoint
    timenum
    condition
    short_comp

The column **original_name** must have the names of the samples as given in your data.

The column **name_to_plot** must have the names as you want them to be (or set identical to original_name if you prefer). To set names that are meaningful is a better choice, as we will take them to display the results.

The column **timenum** must contain only the numeric part of the timepoint, for example 2,0, 10, 100 (this means, without letters ("T", "t", "s", "h" etc) nor any other symbol). Make sure these time numbers are in the same units (but do not write the units here!).

The column **short_comp** is an abbreviation, coined by you, for the compartments. This will be used for the results' files names: the longer the compartments names are, the longer the output files' names! Please pick short and clear abbreviations to fill this column.

 ]]>
    </help>
    <expand macro="citations" />
</tool>