<macros>
    <token name="@TOOL_VERSION@">1.0.0</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@EXECUTABLE@">pca</token>
    <xml name="factor_repeat">
        <repeat name="rep_factorName" title="Factor" min="1">
            <param name="factorName" type="text" value="FactorName" label="Specify a factor name, e.g. effects_drug_x or cancer_markers"
                help="Only letters, numbers and underscores will be retained in this field">
                <sanitizer>
                    <valid initial="string.letters,string.digits"><add value="_" /></valid>
                </sanitizer>
            </param>
            <repeat name="rep_factorLevel" title="Factor level" min="2" default="2">
                <param name="factorLevel" type="text" value="FactorLevel" label="Specify a factor level, typical values could be 'tumor', 'normal', 'treated' or 'control'"
                    help="Only letters, numbers and underscores will be retained in this field">
                    <sanitizer>
                        <valid initial="string.letters,string.digits"><add value="_" /></valid>
                    </sanitizer>
                </param>
                <yield/>
            </repeat>
        </repeat>
    </xml>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="0.1.0">dimet</requirement>
        </requirements>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="bibtex">
            @software{Galvis_Rodriguez_DIMet,
                author = {Galvis Rodriguez, Johanna  and Guyon, Joris and Dartigues, Benjamin and Specque, Florian and Daubon, Thomas and Karkar, Slim and Nikolski, Macha},
                license = {MIT},
                title = {{DIMet}},
                url = {https://github.com/cbib/DIMet}
            }
            </citation>
        </citations>

    </xml>
    <xml name="input_parameters_pca">
        <param name="abundance_file" type="data" format="tabular" label="Metabolite abundance file"/>
        <param name="me_or_frac_contrib_file" type="data" optional="true" format="tabular" label="Mean enrichment or fraction contribution file"/>
        <param name="isotop_prop_file" type="data" optional="true" format="tabular" label="Isotopologues proportion abundance file"/>
        <param name="isotop_abs_file" type="data" optional="true" format="tabular" label="Isotopologues absolute abundance file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>  
    </xml>
    <xml name="input_parameters_abundance">
        <param name="abundance_file" type="data" format="tabular" label="Metabolite abundance file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
    </xml>
    <xml name="input_parameters_enrichment">
        <param name="me_or_frac_contrib_file" type="data" format="tabular" label="Metabolite enrichment file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
    </xml>
    <xml name="input_parameters_metabologram">
        <conditional name="data_input">
            <param name="data_input_selector" type="select" label="Abundance, Enrichment or Isotopologues count files" help="Select between raw abundance and mean enrichment files">
                <option value="abundance" selected="True">abundance</option>
                <option value="mean_enrichment">mean_enrichment</option>
            </param>
            <when value="abundance">
                <param name="abundance_file" type="data" format="tabular" label="Metabolite abundance file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="abundance_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="abundance_stat_test" type="select" value="Tt" display="radio" label="Select statistical to apply to abundance file" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
            <when value="mean_enrichment">
                <param name="me_or_frac_contrib_file" type="data" format="tabular" label="Mean enrichment or fraction contribution file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="me_or_frac_contrib_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="meanE_or_fracContrib_stat_test" type="select" value="Tt"  display="radio" label="Select statistical to apply" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
        </conditional>
        <param name="path_kegg_metabolites" type="data" format="tabular" label="Pathways kegg metabolites file"/>
        <param name="path_kegg_transcripts" type="data" format="tabular" label="Pathways kegg transcripts file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
    </xml>

    <xml name="input_parameters_diff_analysis">
        <conditional name="data_input">
            <param name="data_input_selector" type="select" label="Abundance, Enrichment or Isotopologues count files" help="Select between raw abundance and mean enrichment files">
                <option value="abundance" selected="True">abundance</option>
                <option value="mean_enrichment">mean_enrichment</option>
                <option value="isotop_prop">isotop_prop</option>
                <option value="isotop_abs">isotop_abs</option>
            </param>
            <when value="abundance">
                <param name="abundance_file" type="data" format="tabular" label="Metabolite abundance file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="abundance_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="abundance_stat_test" type="select" value="Tt" display="radio" label="Select statistical to apply to abundance file" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
            <when value="mean_enrichment">
                <param name="me_or_frac_contrib_file" type="data" format="tabular" label="Mean enrichment or fraction contribution file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="me_or_frac_contrib_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="meanE_or_fracContrib_stat_test" type="select" value="Tt"  display="radio" label="Select statistical to apply" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
            <when value="isotop_prop">
                <param name="isotop_prop_file" type="data" format="tabular" label="Isotopologues proportion abundance file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="isotop_prop_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="isotopologue_prop_stat_test" type="select" value="Tt" display="radio" label="Select statistical to apply" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
            <when value="isotop_abs">
                <param name="isotop_abs_file" type="data" format="tabular" label="Isotopologues absolute abundance file"/>
                <param name="metabolites_list" type="select" optional="false" multiple="true"
                       label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a isotopologues file prior to have acccess to metabolite list">
                    <validator type="length" min="1" message="Please enter at max 2 compartments"/>
                    <options from_dataset="isotop_abs_file">
                        <column name="metabolite_or_isotopologue" index="0"/>
                        <column name="value" index="0"/>
                        <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                        <filter type="remove_value" value="metabolite_or_isotopologue"/>
                        <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
                    </options>
                    <sanitizer>
                        <valid initial="default">
                            <add preset="string.printable"/>
                            <add value="\t"/>
                            <remove value="&quot;"/>
                            <remove value="&apos;"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="isotopologue_abs_stat_test" type="select" value="Tt" display="radio" label="Select statistical to apply" help="Please enter at max 1 statistical test by file">
                    <option value="Tt">t-test</option>
                    <option value="MW">Mann Whitney</option>
                    <option value="KW">Kruskall Wallis</option>
                    <option value="ranksum">Wilcoxon's rank sum test</option>
                    <option value="Wcox">Wilcoxon signed-rank test</option>
                    <option value="BrMu">Brunner-Munzel test</option>
                    <option value="prm-scipy">permutations test</option>
                    <option value="disfit">distribution fitting (of the z-score of the ratios), disfit needs several hundreds of metabolites to be trustful.</option>
                </param>
            </when>
        </conditional>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>
    </xml>
    <xml name="suffix">
        <param name="suffix" type="text" optional="false" label="suffix to add to output files" >
            <sanitizer invalid_char="">
                <valid initial="string.ascii_letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
        </param>      
    </xml>
    <xml name="conditions">
        <param name="conditions" type="select" optional="false" multiple="true" label="Browse conditions from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
            <options from_dataset="metadata_path">
                <column name="condition" index="1"/>
                <column name="value" index="1"/>
                <filter type="unique_value" name="condition" column="condition"/>
                <filter type="remove_value" value="condition"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    <xml name="timepoint">
        <param name="timepoint" type="select" optional="true" multiple="true" label="Browse timepoint from metadata file (2 Max.)">
            <options from_dataset="metadata_path">
                <column name="timepoint" index="2"/>
                <column name="value" index="2"/>
                <filter type="unique_value" name="timepoint" column="2"/>
                <filter type="remove_value" value="timepoint"/>
                <filter type="sort_by" name="timepoint" column="1"/>
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    <xml name="grouping">
        <param name="grouping" type="select"  optional="false" multiple="true" label="Browse group to compare">
            <option value="condition" selected="true">condition</option>
            <option value="timepoint" selected="true">timepoint</option>
        </param>
    </xml>
    <xml name="correction_method">
        <param name="correction_method" type="select" value="bonferroni" display="radio" label="Select multiple test correction to apply" help="Please enter at max 1 method">
                    <option value="bonferroni">bonferroni</option>
                    <option value="holm-sidak">holm-sidak</option>
                    <option value="holm">holm</option>
                    <option value="simes-hochberg">simes-hochberg</option>
                    <option value="hommel">hommel</option>
                    <option value="fdr_bh">fdr_bh</option>
                    <option value="fdr_by">fdr_by</option>
                    <option value="fdr_tsbh">fdr_tsbh</option>
                    <option value="fdr_tsbky">fdr_tsbky</option>
        </param>
    </xml>
    <xml name="compartments">
        <param name="compartments" type="select" optional="false" multiple="true"
               label="Browse compartments from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
<!--            <validator type="length" min="1" message="Please enter at min 1 compartments"/>-->
            <options from_dataset="metadata_path">
                <column name="short_comp" index="4"/>
                <column name="value" index="4"/>
                <filter type="unique_value" name="short_comp" column="4"/>
                <filter type="remove_value" value="short_comp"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    <xml name="abundance_metabolites_list">
        <param name="metabolites_list" type="select" optional="false" multiple="true"
               label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
            <validator type="length" min="1" message="Please enter at max 2 compartments"/>
            <options from_dataset="abundance_file">
                <column name="metabolite_or_isotopologue" index="0"/>
                <column name="value" index="0"/>
                <filter type="unique_value" name="metabolite_or_isotopologue" column="0"/>
                <filter type="remove_value" value="metabolite_or_isotopologue"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    <xml name="enrichment_metabolites_list">
    <param name="metabolites_list" type="select" optional="false" multiple="true"
               label="Select Metabolite(s) for factor 1 to plot (2 Max.). You have to load a abundance file prior to have acccess to metabolite list">
            <validator type="length" min="1" message="Please enter at max 2 compartments"/>
            <options from_dataset="me_or_frac_contrib_file">
                <column name="ID" index="0"/>
                <column name="value" index="0"/>
                <filter type="unique_value" name="ID" column="0"/>
                <filter type="remove_value" value="ID"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    <xml name="deg_list">
        <repeat name="deg_list" title="Deregulated gene set">
            <param name="input" type="data" format="tabular" label="Deregulated genes set"/>
            <param name="idcol" type="data_column" data_ref="input" label="Column for id" use_header_names="true"/>
            <param name="valuecol" type="data_column" data_ref="input" label="Column for values" use_header_names="true"/>
        </repeat>
    </xml>

    <token name="@INIT_PCA@"><![CDATA[
    #import json
    #import re

    mkdir -p data/raw &&
    mkdir -p data/processed &&

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if

    ####set $impute_values  = {}
    #if $abundance_file:
        ln '$abundance_file' data/raw/abundance.csv &&
    #end if
    #if $me_or_frac_contrib_file:
        ln '$me_or_frac_contrib_file' data/raw/me_or_frac_contrib.csv &&
    #end if
    #if $isotop_abs_file:
        ln '$isotop_abs_file' data/raw/isotop_abs.csv &&
    #end if
    #if $isotop_prop_file:
        ln '$isotop_prop_file' data/raw/isotop_prop.csv &&
    #end if

    ]]></token>
    <token name="@INIT_ABUNDANCE_PLOT@"><![CDATA[

    mkdir -p data/raw &&
    mkdir -p data/processed &&

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if
    #if $abundance_file:
        ln '$abundance_file' data/raw/abundance.csv &&
    #end if
    ]]></token>
    <token name="@INIT_ENRICHMENT_PLOT@"><![CDATA[

    mkdir -p data/raw &&
    mkdir -p data/processed &&

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if
    #if $me_or_frac_contrib_file:
        ln '$me_or_frac_contrib_file' data/raw/me_or_frac_contrib.csv &&
    #end if
    ]]></token>
    <token name="@INIT_DIFF_ANALYSIS@"><![CDATA[

    mkdir -p data/raw &&
    mkdir -p data/processed &&

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if

    #set $impute_values  = {}
    #if str( $data_input.data_input_selector ) == "abundance":
        #if $data_input.abundance_file:
            ln '$data_input.abundance_file' data/raw/abundance.csv &&
            #silent $impute_values['abundances']='min'
        #end if
    #elif str( $data_input.data_input_selector ) == "mean_enrichment":
        #if $data_input.me_or_frac_contrib_file:
            ln '$data_input.me_or_frac_contrib_file' data/raw/me_or_frac_contrib.csv &&
            #silent $impute_values['mean_enrichment']='min'
        #end if
    #elif str( $data_input.data_input_selector ) == "isotop_prop":
        #if $data_input.isotop_prop_file:
            ln '$data_input.isotop_prop_file' data/raw/isotop_prop.csv &&
            #silent $impute_values['isotopologue_proportions']='min'
        #end if
    #else
        #if $data_input.isotop_abs_file:
            ln '$data_input.isotop_abs_file' data/raw/isotop_abs.csv &&
            #silent $impute_values['isotopologues']='min'
        #end if
    #end if
    ]]></token>
    <token name="@INIT_METABOLOGRAM@"><![CDATA[
    #import json
    #import re
    #import os
    #import csv
    #import subprocess

    mkdir -p data/raw &&
    mkdir -p data/processed &&
    mkdir -p data/integration_files &&

    #if $path_kegg_metabolites:
        ln '$path_kegg_metabolites' data/integration_files/pathways_kegg_metabolites.csv &&
    #end if
    #if $path_kegg_transcripts:
        ln '$path_kegg_transcripts' data/integration_files/pathways_kegg_transcripts.csv &&
    #end if

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if

    #set $impute_values  = {}
    #if str( $data_input.data_input_selector ) == "abundance":
        #if $data_input.abundance_file:
            ln '$data_input.abundance_file' data/raw/abundance.csv &&
            #silent $impute_values['abundances']='min'
        #end if
    #else:
        #if $data_input.me_or_frac_contrib_file:
            ln '$data_input.me_or_frac_contrib_file' data/raw/me_or_frac_contrib.csv &&
            #silent $impute_values['mean_enrichment']='min'
        #end if
    #end if

    #for $i, $s in enumerate($deg_list)
        #set $cpt = str($i+1)
        ln '${s.input}' data/integration_files/DEG_comparison'${cpt}'.csv &&
    #end for


    ]]></token>
    <token name="@INIT_IMPUTE_VALUES@"><![CDATA[
    #import re
    #set $impute_values  = {}
    #if $abundance_file:
        #silent $impute_values['abundances']='min'
    #end if
    #if $me_or_frac_contrib_file:
        #silent $impute_values['mean_enrichment']='min'
    #end if
    #if $isotop_abs_file:
        #silent $impute_values['isotop_abs']='min'
    #end if
    #if $isotop_prop_file:
        #silent $impute_values['isotop_prop']='min'
    #end if
    ]]></token>
    <token name="@INIT_STAT_TEST@"><![CDATA[
    #import re
    #set $statistical_test  = {}
    #if str( $data_input.data_input_selector ) == "abundance":
        #if $data_input.abundance_file:
            #silent $statistical_test['abundances']=str($data_input.abundance_stat_test)
        #end if
    #elif str( $data_input.data_input_selector ) == "mean_enrichment":
        #if $data_input.me_or_frac_contrib_file:
            #silent $statistical_test['mean_enrichment']=str($data_input.meanE_or_fracContrib_stat_test)
        #end if
    #elif str( $data_input.data_input_selector ) == "isotop_prop":
        #if $data_input.isotop_prop_file:
            #silent $statistical_test['isotopologue_proportions']=str($data_input.isotopologue_prop_stat_test)
        #end if
    #else
        #if $data_input.isotop_abs_file:
            #silent $statistical_test['isotopologues']=str($data_input.isotopologue_abs_stat_test)
        #end if
    #end if
    ]]></token>
    <token name="@INIT_CONDITIONS@"><![CDATA[
    #import re
    #set $conds = list()
    #for $co in $conditions:
        $conds.append(re.sub('"', '', str($co)))
    #end for
    ]]></token>
    <token name="@INIT_TIMEPOINTS@"><![CDATA[

    #import re
    #set $timepoints = list()
    #for $tp in $timepoint:
        $timepoints.append(re.sub('"', '', str($tp)))
    #end for
    ]]></token>
    <token name="@INIT_GROUPS@"><![CDATA[
    #import re
    #set $groups = list()
    #for $g in $grouping:
        $groups.append(re.sub('"', '', str($g)))
    #end for
    ]]></token>
    <token name="@INIT_METABOLITES@"><![CDATA[
    #import json
    #import re
    #set $metabolites = {}
    #for $cp in $compartments:
        #silent $metabolites[re.sub('"', '', str($cp))]=list()
        #for $met in $metabolites_list:
            $metabolites[re.sub('"', '', str($cp))].append(re.sub('"', '\'', str($met)))
        #end for
    #end for
    ]]></token>
    <token name="@INIT_COMPARISONS@"><![CDATA[
    #import re
    #set $conds = list()
    #for $co in $conditions:
        $conds.append(re.sub('"', '', str($co)))
    #end for
    #import re
    #set $timepoints = list()
    #for $tp in $timepoint:
        $timepoints.append(re.sub('"', '', str($tp)))
    #end for

    #set $comparisons = list()
    #if len($conds) > 1:
        #if len($timepoints) > 0:
            #for $tp in $timepoint:
                #set $ctrl_found=False
                #set $ctrl=""
                #set $comparisons_bis = list()
                #for $co in $conditions:
                    #set $sub_comparisons = list()
                    #if str($co) in ["Control", "control","ctrl"]:
                        #set $ctrl_found=True
                        #set $ctrl=str($co)
                    #else:
                        $sub_comparisons.append(re.sub('"', '', str($co)))
                        $sub_comparisons.append(re.sub('"', '', str($tp)))

                    #end if
                    $comparisons_bis.append($sub_comparisons)
                #end for

                #if $ctrl_found:
                    $sub_comparisons.append(str($ctrl))
                    $sub_comparisons.append(str($tp))
                    $comparisons_bis.append($sub_comparisons)
                #end if

                $comparisons.append($comparisons_bis)
            #end for
         #else
            ##set $comparisons_bis = list()
            #for $co in $conditions:
                $comparisons.append(re.sub('"', '', str($co)))
            #end for
            ###$comparisons.append($comparisons_bis)
        #end if

    #else
        #if len($conds) > 0:
            #if len($timepoints) > 1:
                #for $co in $conditions:
                    #set $comparisons_bis = list()
                    #for $tp in $timepoint:
                        #set $sub_comparisons = list()
                        $sub_comparisons.append(re.sub('"', '', str($co)))
                        $sub_comparisons.append(re.sub('"', '', str($tp)))
                        $comparisons_bis.append($sub_comparisons)
                    #end for
                    $comparisons.append($comparisons_bis)
                #end for
            #end if
        #else
            #for $tp in $timepoint:
                $comparisons.append(re.sub('"', '', str($tp)))
            #end for
        #end if
    #end if
    ]]></token>
    <token name="@INIT_TRANSCRIPTS@"><![CDATA[
    #import re
    #import os
    #import subprocess
    #set $transcripts  = list()
    #for $i, $s in enumerate($deg_list)
        #set $cpt = str($i+1)
        $transcripts.append(re.sub('"', '', "DEG_comparison"+str($i+1)))
        #set $deg_one_values = os.fsdecode(subprocess.check_output('head -n1 ' + str($s.input) + '| cut -f' + str($s.valuecol), shell=True))
        #set $deg_one_id = os.fsdecode(subprocess.check_output('head -n1 ' + str($s.input) + '| cut -f' + str($s.idcol), shell=True))
    #end for
    ]]></token>
    <token name="@INIT_PATHWAYS@"><![CDATA[
    #set $pathways  = {}
    #if $path_kegg_metabolites:
        #silent $pathways['metabolites']='pathways_kegg_metabolites'
    #end if
    #if $path_kegg_transcripts:
        #silent $pathways['transcripts']='pathways_kegg_transcripts'
    #end if
    ]]></token>
</macros>
