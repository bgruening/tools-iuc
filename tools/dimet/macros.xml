<macros>
    <token name="@TOOL_VERSION@">1.0.0</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@EXECUTABLE@">pca</token>
    <xml name="factor_repeat">
        <repeat name="rep_factorName" title="Factor" min="1">
            <param name="factorName" type="text" value="FactorName" label="Specify a factor name, e.g. effects_drug_x or cancer_markers"
                help="Only letters, numbers and underscores will be retained in this field">
                <sanitizer>
                    <valid initial="string.letters,string.digits"><add value="_" /></valid>
                </sanitizer>
            </param>
            <repeat name="rep_factorLevel" title="Factor level" min="2" default="2">
                <param name="factorLevel" type="text" value="FactorLevel" label="Specify a factor level, typical values could be 'tumor', 'normal', 'treated' or 'control'"
                    help="Only letters, numbers and underscores will be retained in this field">
                    <sanitizer>
                        <valid initial="string.letters,string.digits"><add value="_" /></valid>
                    </sanitizer>
                </param>
                <yield/>
            </repeat>
        </repeat>
    </xml>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="0.1.0">dimet</requirement>
        </requirements>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="bibtex">
                @software{Galvis_Rodriguez_DIMet,
                    author = {Galvis Rodriguez, Johanna  and Guyon, Joris and Dartigues, Benjamin and Specque, Florian and Daubon, Thomas and Karkar, Slim and Nikolski, Macha},
                    license = {MIT},
                    title = {{DIMet}},
                    url = {https://github.com/cbib/DIMet}
                    }
            </citation>
        </citations>
    </xml>
    <xml name="input_parameters">
        <param name="abundance_file" type="data" format="tabular" label="Metabolite abundance file"/>
        <param name="me_or_frac_contrib_file" type="data" optional="true" format="tabular" label="Mean enrichment or fraction contribution file"/>
        <param name="isotop_prop_file" type="data" optional="true" format="tabular" label="Isotopologues proportion abundance file"/>
        <param name="isotop_abs_file" type="data" optional="true" format="tabular" label="Isotopologues absolute abundance file"/>
        <param name="metadata_path" type="data" format="tabular" label="metadata file"/>  
    </xml>
    <xml name="suffix">
        <param name="suffix" type="text" optional="false" label="suffix to add to output files" >
            <sanitizer invalid_char="">
                <valid initial="string.ascii_letters,string.digits">
                    <add value="_" />
                </valid>
            </sanitizer>
        </param>      
    </xml>
    <xml name="conditions">
        <param name="conditions" type="select" optional="false" multiple="true" label="Browse conditions from metadata file (2 Max.). You have to load a metadata file prior to have acccess to metabolite list">
            <options from_dataset="metadata_path">
                <column name="condition" index="1"/>
                <column name="value" index="1"/>
                <filter type="unique_value" name="condition" column="condition"/>
                <filter type="remove_value" value="condition"/>
                <!--                <filter type="sort_by" name="timepoint" column="1"/>-->
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>
    
    <xml name="timepoint">
        <param name="timepoint" type="select" optional="true" multiple="true" label="Browse timepoint from metadata file (2 Max.)">
            <options from_dataset="metadata_path">
                <column name="timepoint" index="2"/>
                <column name="value" index="2"/>
                <filter type="unique_value" name="timepoint" column="2"/>
                <filter type="remove_value" value="timepoint"/>
                <filter type="sort_by" name="timepoint" column="1"/>
            </options>
            <sanitizer>
                <valid initial="default">
                    <add preset="string.printable"/>
                    <add value="\t"/>
                    <remove value="&quot;"/>
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>
    </xml>

    <token name="@INIT@"><![CDATA[
    #import json
    #import re

    mkdir -p data/raw &&
    mkdir -p data/processed &&

    #if $metadata_path:
        ln '$metadata_path' data/raw/metadata.csv &&
    #end if

    #set $impute_values  = {}
    #if $abundance_file:
        ln '$abundance_file' data/raw/abundance.csv &&
        #silent $impute_values['abundances']=re.sub('"', '', "min")
    #end if
    #if $me_or_frac_contrib_file:
        ln '$me_or_frac_contrib_file' data/raw/me_or_frac_contrib.csv &&
        #silent $impute_values['mean_enrichment']=re.sub('"', '', "min")
    #end if
    #if $isotop_abs_file:
        ln '$isotop_abs_file' data/raw/isotop_abs.csv &&
        #silent $impute_values['isotop_abs']=re.sub('"', '', "min")
    #end if

    #if $isotop_prop_file:
        ln '$isotop_prop_file' data/raw/isotop_prop.csv &&
        #silent $impute_values['isotop_prop']=re.sub('"', '', "min")
    #end if
    #set $conds = list()
    #for $co in $conditions:
        $conds.append(re.sub('"', '', str($co)))
    #end for 
    ]]></token>

</macros>
