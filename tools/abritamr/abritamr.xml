<tool id="abritamr" name="abriTAMR" version="@WRAPPER_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>AMR gene detection with AMRFinderPlus</description>
    <macros>
        <token name="@WRAPPER_VERSION@">1.0.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">22.05</token>
    </macros>
    <requirements>
        <requirement type="package" version="1.0.14">abritamr</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
#set args = ''
touch input.tsv &&

#if $input.input_type in ['collection']:
    #for $i in $input.fasta_collection:
        echo $i.element_identifier,$i >> input.tsv &&
    #end for
#else
    echo $input.contig.element_identifier,$input.contig >> input.tsv &&
#end if
sed -i 's/\,/\t/g' input.tsv &&

abritamr run
    --contigs input.tsv
    --jobs \${GALAXY_SLOTS:-4}
#if str($options.species) != "None":
    --species '$options.species'
#end if
#if str($options.identity):
    --identity '$options.identity'
#end if
    $args
]]></command>
    <inputs>
        <conditional name="input">
            <param name="input_type" type="select" label="Choose the files to be analyzed">
                <option value="single" selected="true">Single sample</option>
                <option value="collection">Sample collection</option>
            </param>
            <when value="single">
                <param name="contig" type="data" format="fasta" label="Single sample"/>
            </when>
            <when value="collection">
                <param name="fasta_collection" type="data_collection" collection_type="list" format="fasta" label="Collection of fastqsanger paired read files"/>
            </when>
        </conditional>
        <section name="options" title="Output options">
            <param argument="species" type="select" multiple="false" label="Specify species to aquire sresistance mechanisms as point mutations">
                <option value="None">None</option>
                <option value="Neisseria">Neisseria</option>
                <option value="Clostridioides_difficile">Clostridioides difficile</option>
                <option value="Acinetobacter_baumannii">Acinetobacter baumannii</option>
                <option value="Campylobacter">Campylobacter</option>
                <option value="Enterococcus_faecalis">Enterococcus faecalis</option>
                <option value="Enterococcus_faecium">Enterococcus faecium</option>
                <option value="Escherichia">Escherichia</option>
                <option value="Klebsiella">Klebsiella</option>
                <option value="Salmonella">Salmonella</option>
                <option value="Staphylococcus_aureus">Staphylococcus aureus</option>
                <option value="Staphylococcus_pseudintermedius">Staphylococcus pseudintermedius</option>
                <option value="Streptococcus_agalactiae">Streptococcus agalactiae</option>
                <option value="Streptococcus_pneumoniae">Streptococcus pneumoniae</option>
                <option value="Streptococcus_pyogenes">Streptococcus pyogenes</option>
            </param>
            <param argument="identity" type="float" optional="true" label="Minimum identity of matches with armfinder. Default: 0.9, unless curated threshold is present."/>
            <param argument="log" type="boolean" truevalue="t" falsevalue="f" checked="false" label="Include output logfile."/>
        </section>
    </inputs>
    <outputs>
        <collection name="summary_output" type="list" label="${tool.name} on ${on_string}: Summary outputs">
            <data name="abriTAMR output" format="txt" label="${tool.name} on ${on_string} abriTAMR.txt" from_work_dir="abritamr.txt" />
            <data name="Matches summary" format="txt" label="${tool.name} on ${on_string} matches" from_work_dir="summary_matches.txt"/>
            <data name="Partials summary" format="txt" label="${tool.name} on ${on_string} partials" from_work_dir="summary_partials.txt"/>
            <data name="Virulence summary" format="txt" label="${tool.name} on ${on_string} virulence" from_work_dir="summary_virulence.txt"/>
            <data name="log" format="txt" label="${tool.name} on ${on_string} Log file" from_work_dir="abritamr.log">
                <filter>options['log'] == "t" </filter>
            </data>
        </collection>
    </outputs>
    <tests>
        <!-- Single sample -->
        <test>
            <param name="input_type" value="single" />
            <param name="contig" value="CP009102.1.fasta" />
            <param name="species" value="Salmonella" />
            <param name="identity" value="0.5" />
            <param name="log" value="t" />
            <output_collection name="summary_output" type="list">
                <element name="abriTAMR output">
                    <assert_contents>
                        <has_n_lines n="2"/>
                    </assert_contents>
                </element>
                <element name="Matches summary">
                    <assert_contents>
                        <has_n_lines n="2"/>
                    </assert_contents>
                </element>
                <element name="Partials summary">
                    <assert_contents>
                        <has_n_lines n="2"/>
                    </assert_contents>
                </element>
                <element name="Virulence summary">
                    <assert_contents>
                        <has_n_lines n="2"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- Multi sample -->
        <test>
            <param name="input_type" value="collection" />
            <param name="fasta_collection">
                <collection type="list">
                    <element name="NC_003198.1_1kb.fasta" value="NC_003198.1_1kb.fasta" />
                    <element name="NC_011750.1_1kb.fasta" value="NC_011750.1_1kb.fasta" />
                </collection>
            </param>
            <output_collection name="summary_output" type="list">
                <element name="Matches summary">
                    <assert_contents>
                        <has_n_lines n="3"/>
                    </assert_contents>
                </element>
                <element name="Partials summary">
                    <assert_contents>
                        <has_n_lines n="3"/>
                    </assert_contents>
                </element>
                <element name="Virulence summary">
                    <assert_contents>
                        <has_n_lines n="3"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help>
*Taming the AMR beast*

abriTAMR is an AMR gene detection pipeline that runs AMRFinderPlus on a single (or list ) of given isolates and collates the results into a table, separating genes identified into functionally relevant groups. abriTAMR is accredited by NATA for use in reporting the presence of reportable AMR genes in Victoria Australia.
    + Acquired resistance mechanims in the form of point mutations (restricted to subset of species)
    + Streamlined output.
    + Presence of virulence factors
    </help>
    <citations>
        <citation type="doi">
            https://doi.org/10.5281/zenodo.7370627
        </citation>
    </citations>
</tool>
