<tool id="hybpiper" name="Hybpiper" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Analyse targeted sequence capture data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[

    ## set up files
    ln -s '$targetfile_dna' ./target_file.fasta
    &&

    my_tmpdir=\$( mktemp -d )
    &&

    ###############################
    ## hybpiper check_targetfile ##
    ###############################

    #if str( $job_conditional.hybpiper_job ) == "check_and_fix_targetfile":
        hybpiper check_targetfile 
        --targetfile_dna target_file.fasta
        &&

        mv fix_targetfile*.ctl hybpiper.ctl
        &&

        hybpiper fix_targetfile
        --targetfile_dna target_file.fasta
        --allow_gene_removal
        hybpiper.ctl
    
    #######################
    ## hybpiper assemble ##
    #######################

    #elif str( $job_conditional.hybpiper_job ) == "assemble":
        #if str($job_conditional.prefix) != '':
            #set sample_prefix = str($job_conditional.prefix)
        #else:
            #import re
            #set sample_name = re.sub(r'[._]([Rr])?1([._])?.*', '', str($R1.element_identifier))
            #set sample_prefix = re.sub(r'[^A-Za-z0-9_\-]', '', sample_name)
        #end if
        ln -s "\${my_tmpdir}" '${sample_prefix}'
        &&

        hybpiper assemble
        --readfiles '$R1' '$R2'
        #if $unpaired:
            --unpaired '${unpaired}'
        #end if
        --targetfile_dna target_file.fasta
        --diamond
        --cpu \${GALAXY_SLOTS:-1}
        --prefix '${sample_prefix}'
        &&

        tar -cvf '${sample_prefix}.tar' --directory="\${my_tmpdir}" .
        &&

        cp '$c1' galaxy.json

    #######################################
    ## hybpiper stats/retrieve_sequences ##
    #######################################

    #elif str( $job_conditional.hybpiper_job ) == "stats":
        #for $sample in $job_conditional.hybpiper_results
            #set sample_name = str($sample.designation)
            mkdir -p '${sample_name}'
            &&

            tar -xf '$sample'
            -C '${sample_name}'
            &&

            echo '${sample_name}' >> namelist.txt
            &&
        #end for
        #if ('stats' in $job_conditional.output_type or 'heatmap' in $job_conditional.output_type):
            hybpiper stats
            --targetfile_dna target_file.fasta
            --stats_filename stats
            --seq_lengths_filename seq_lengths
            gene
            namelist.txt
            &&
        #end if
        #if 'sequences' in $job_conditional.output_type:
            mkdir fasta_out
            &&

            hybpiper retrieve_sequences
            --targetfile_dna target_file.fasta
            --sample_names namelist.txt
            --fasta_dir fasta_out
            dna
            &&
        #end if
        #if 'heatmap' in $job_conditional.output_type:
            hybpiper recovery_heatmap
            --heatmap_filename heatmap
            --figure_height 9 --figure_length 16 
            seq_lengths.tsv
        #end if
    #end if
    
]]></command>

    <configfiles>
        <configfile name="c1">
        #import re
        #import json
        #set $elems = []
        #if str( $job_conditional.hybpiper_job ) == "assemble"
            #if str($job_conditional.prefix) != '':
                #set sample_prefix = str($job_conditional.prefix)
            #else
                #set sample_name = re.sub(r'[._]([Rr])?1([._])?.*', '', str($R1.element_identifier))
                #set sample_prefix = re.sub(r'[^A-Za-z0-9_\-]', '', sample_name)
            #end if
            #set $elems = [{'filename': '%s.tar' % sample_prefix, 'designation': '%s' % sample_prefix, 'name':  'Hybpiper assembly archive for %s' % sample_prefix, 'ext': 'tar'}]
        #end if
        #echo json.dumps({'archives': {'datasets': $elems}})</configfile>
    </configfiles>
    
    <inputs>
        <param argument="--targetfile_dna" type="data" format="fasta" label="Target file" help="Target file in FASTA format" />
    
        <conditional name="job_conditional">
            <param name="hybpiper_job" type="select" label="Type of hybpiper run">
                <option value="check_and_fix_targetfile">Check and fix targetfile</option>
                <option value="assemble">Assemble target loci</option>
                <option value="stats">Extract sequences and/or stats from Hybpiper runs</option>
            </param>
    
            <when value="check_and_fix_targetfile">              
            </when>
    
            <when value="assemble">
                <param name="R1" type="data" format="fastqsanger" label="R1 read file"/>
                <param name="R2" type="data" format="fastqsanger" label="R2 read file" />
                <param name="unpaired" optional="true" type="data" format="fastqsanger" label="Unpaired reads" help="If you kept the unpaired reads from adaptor trimming, you can use them here." />
                <param argument="--prefix" optional="true" type="text" value="" label="Override the sample name." help="If you leave this blank, the name of the R1 read file will be used (recommended).">
                    <validator type="regex">[0-9a-zA-Z_]+</validator>     
                </param>
            </when>
    
            <when value="stats">
                <param name="stats_type_select" type="select" label="Choose statistics to report" display="checkboxes">
                    <option value="gene" selected="true">Gene</option>
                    <option value="supercontig">Supercontig</option>
                </param>
                <param name="sequence_type_select" type="select" display="checkboxes" label="Choose sequences to extract">
                    <option value="dna" selected="true">DNA</option>
                    <option value="aa">Amino acid</option>
                    <option value="intron">Intron</option> 
                    <option value="supercontig">Supercontig</option>
                </param>           
                <param name="heatmap_type_select" type="select" label="Choose type of heatmap to produce" display="checkboxes" optional="true">
                    <option value="gene" >Gene</option>
                    <option value="supercontig">Supercontig</option>

                </param>
            </when>
        </conditional>
    </inputs>
    
    <outputs>
        <!-- check_targetfile output -->
        <collection type="list" name="output_targetfile" label="${targetfile_dna.element_identifier} (fixed)">
            <data name="fixed_targetfile" label="${targetfile_dna.element_identifier} (fixed)" format="fasta" from_work_dir="target_file_fixed.fasta"/>
            <data name="targetfile_ctl_file" label="Hybpiper .ctl file for ${on_string}" format="txt" from_work_dir="hybpiper.ctl" />
            <data name="targetfile_report" label="Hybpiper targetfile report" format="tabular" from_work_dir="fix_targetfile_report.tsv" />
            <filter>job_conditional['hybpiper_job'] == 'check_and_fix_targetfile'</filter>
        </collection>

        <!-- assemble output -->
        <data name="archives" format="tar">
            <discover_datasets from_provided_metadata="true" visible="true" />
            <filter>job_conditional['hybpiper_job'] == 'assemble'</filter>
        </data>

        <!-- stats / stats output -->
        <collection name="hybpiper_stats" type="list" label="Hybpiper statistics">
            <data name="stats" format="tabular" from_work_dir="stats.tsv" label="Hybpiper statistics table">
            </data>
            <data name="seq_lengths" format="tabular" from_work_dir="seq_lengths.tsv" label="Lengths of assembled sequences">
            </data>
            <filter>job_conditional['hybpiper_job'] == 'stats' and 'stats' in job_conditional['output_type']</filter>
        </collection>

        <!-- stats/sequences output -->
        <collection name="hybpiper_sequences" type="list" label="Assembled sequences">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.FNA" format="fasta" directory="fasta_out" recurse="false" />
            <filter>job_conditional['hybpiper_job'] == 'stats' and 'sequences' in job_conditional['output_type']</filter>
        </collection>

        <!-- stats/heatmap output -->
        <data name="hybpiper_heatmap" label="Hybpiper recovery heatmap" format="png" from_work_dir="heatmap.png">
            <filter>job_conditional['hybpiper_job'] == 'stats' and 'heatmap' in job_conditional['output_type']</filter>
        </data>    

    </outputs>
    <tests>

    <!-- test1: check and fix targetfile -->
    <test expect_num_outputs="4">
        <param name="targetfile_dna" value="test_targets.fasta.gz"/>
        <conditional name="job_conditional">
            <param name="hybpiper_job" value="check_and_fix_targetfile"/>
        </conditional>
        <output_collection name="output_targetfile" type="list">
            <element name="fixed_targetfile" file="test1_out.fasta"/>
            <element name="targetfile_ctl_file" file="test1_out.ctl"/>    
            <element name="targetfile_report" file="test1_out.tsv"/>
        </output_collection>
    </test>

    <!-- test2: assemble with r1, r2 and unpaired -->
    <!-- should be one output, but assign_primary_output doesn't work -->
    <test expect_num_outputs="1">
        <param name="targetfile_dna" value="test1_out.fasta"/>
        <conditional name="job_conditional">
            <param name="hybpiper_job" value="assemble"/>
            <param name="R1" value="NZ874_R1_test.fastq.gz"/>
            <param name="R2" value="NZ874_R2_test.fastq.gz"/>
            <param name="unpaired" value="NZ874_unpaired_test.fastq.gz"/>
        </conditional>
        <output name="archives" file="test2_out.tar" count="1"/>
    </test>

    <!-- test3: assemble with r1 and r2 but no unpaired. -->
    <!-- should be one output, but assign_primary_output doesn't work -->
    <test expect_num_outputs="1">
        <param name="targetfile_dna" value="test1_out.fasta"/>
        <conditional name="job_conditional">
            <param name="hybpiper_job" value="assemble"/>
            <param name="R1" value="NZ874_R1_test.fastq.gz"/>
            <param name="R2" value="NZ874_R2_test.fastq.gz"/>
        </conditional>
        <output name="archives" file="test3_out.tar" count="1"/>
    </test>

    <!-- test4: set the prefix. -->
    <!-- should be one output, but assign_primary_output doesn't work -->
    <test expect_num_outputs="1">
        <param name="targetfile_dna" value="test1_out.fasta"/>
        <conditional name="job_conditional">
            <param name="hybpiper_job" value="assemble"/>
            <param name="R1" value="NZ874_R1_test.fastq.gz"/>
            <param name="R2" value="NZ874_R2_test.fastq.gz"/>
            <param name="prefix" value="my_sample"/>
        </conditional>
        <output name="archives" file="test4_out.tar" count="1"/>
    </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

HybPiper was designed for targeted sequence capture, in which DNA
sequencing libraries are enriched for gene regions of interest,
especially for phylogenetics. HybPiper is a suite of Python
scripts/modules that wrap and connect bioinformatics tools in order to
extract target sequences from high-throughput DNA sequencing reads.

Targeted bait capture is a technique for sequencing many loci
simultaneously based on bait sequences. The HybPiper pipeline starts
with high-throughput sequencing reads (for example from Illumina MiSeq),
and assigns them to target genes using BLASTx/DIAMOND or BWA. The reads
are distributed to separate directories, where they are assembled
separately using SPAdes. The main output is a FASTA file of the (in
frame) CDS portion of the sample for each target region, and a separate
file with the translated protein sequence.

HybPiper also includes commands to extract the intronic regions flanking
each exon, and investigate putative paralogs. For more information,
please see our wiki.

HybPiper is run separately for each sample (single or paired-end
sequence reads, with an optional file of unpaired reads in the latter
scenerio). When HybPiper generates sequence files from the reads, it
does so in a standardized directory hierarchy. Many of the
post-processing commands rely on this directory hierarchy, so do not
modify it after running the initial pipeline. It is a good idea to run
the pipeline for each sample from the same directory. You will end up
with one directory per run of HybPiper, and some of the later commands
take advantage of this predictable directory structure.

    ]]></help>
    <expand macro="citations"/>
</tool>
