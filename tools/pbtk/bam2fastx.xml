<tool id="bam2fastx" name="PacBio bam2fastx" version="3.1.1+galaxy0">
    <description>PacBio BAM to Fastx</description>
    <requirements>
        <requirement type="package" version="3.1.1">pbtk</requirement>
    </requirements>
    <command detect_errors="aggressive">
        <![CDATA[
            mkdir -p output_files/ &&
            ln -s "$input_bam" input.bam &&
            pbindex input.bam &&
            #if $output_format == "fasta":
                bam2fasta -o output
            #elif $output_format == "fastq":
                bam2fastq -o output
            #end if
            
            input.bam
            --num-threads  "\${GALAXY_SLOTS:-1}"  &&

            #if $output_format == "fasta":
                mv output.fasta.gz "$outputfa"
            #elif $output_format == "fastq":
                mv output.fastq.gz "$outputfq"
            #end if
            
        ]]>
    </command>
    
    <inputs>
        <param name="input_bam" type="data" format="bam" label="PacBio Bam file "/>
        <param name="output_format" type="select" label="Output Format" help="Output a fasta.gz or fastq.gz">
            <option value="fasta">fasta</option>
            <option value="fastq">fastq</option>
        </param>

        
    </inputs>
    
    <outputs>
        <data name="outputfa" format="fasta.gz" label="${tool.name} on ${on_string} : Fasta">
            <filter>output_format == "fasta"</filter>
        </data>
        <data name="outputfq" format="fastq.gz" label="${tool.name} on ${on_string} : Fastq">
            <filter>output_format == "fastq"</filter>
        </data>
    </outputs>
    
    <tests>
        <test expect_num_outputs='1'>
            <param name="input_bam" ftype="bam" value="sample.bam"/>
            <param name="output_format" value="fastq" />
            <output name="outputfq" count='1'>
                <assert_contents>
                    <has_size min='9000' />
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs='1' >
            <param name="input_bam" ftype="bam" value="sample.bam"/>
            <param name="output_format" value="fasta" />
            <output name="outputfa"  count='1'  >
                <assert_contents>
                    <has_size min='9000' />
                </assert_contents>
            </output>
        </test>

    </tests>
    <help>

<![CDATA[

Convert a PacBio BAM file to Fastq or Fasta file. 

]]>
    </help>

        <citations>
            <citation type="bibtex">                                                                   
                @misc{githubpbtk,                                                                 
                author = {},
                year = {2024},                                                                 
                title = {pbtk},                                                        
                publisher = {GitHub},
                journal = {GitHub repository},                                               
                url = {https://github.com/PacificBiosciences/pbtk},                        
                }                                                                    
            </citation>
        </citations>

 </tool>



