<tool id="sinto_fragments" name="Sinto fragments" profile="20.01" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>Create an ATAC-seq fragment file from a BAM file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">sinto</requirement>
    </requirements>
    <version_command>sinto --version</version_command>
    <command><![CDATA[
    sinto fragments 
    --bam $bam 
    --min_mapq $min_mapq 
    --barcodetag '$barcodetag' 
    --barcode_regex '${ str( $barcode_regex ) }'
    --max_distance $max_distance
    --min_distance $min_distance
    --shift_plus $shift_plus
    --shift_minus $shift_minus
    $collapse_within
    --fragments fragments.unsorted.tabular
    --nproc "\${GALAXY_SLOTS:-1}" &&
    sort -k 1,1 -k2,2n fragments.unsorted.tabular > fragments.tabular
]]>    </command>
    <inputs>
        <param argument="--bam" type="data" format="bam" label="Input BAM file" />
        <param argument="--min_mapq" type="integer" value="30" label="Minimum MAPQ required to retain fragment" />
        <param argument="--barcodetag" type="text" value="CB" label="Read tag storing cell barcode information" />
        <param argument="--barcode_regex" type="text" value="[^:]*" label="Read tag storing cell barcode information" 
            help="[^:]* matches all characters up to the first colon" >
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;" />
                </valid>
            </sanitizer>
        </param>
        <param argument="--max_distance" type="integer" value="5000" label="Maximum distance between integration sites for the fragment to be retained" 
            help="Allows filtering of implausible fragments that likely result from incorrect mapping positions. Default is 5000 bp."/>
        <param argument="--min_distance" type="integer" value="10" label="Minimum distance between integration sites for the fragment to be retained" 
            help="Allows filtering of implausible fragments that likely result from incorrect mapping positions. Default is 5000 bp."/>
        <param argument="--shift_plus" type="integer" value="4" label="Minimum MAPQ required to retain fragment" />
        <param argument="--shift_minus" type="integer" value="-5" label="Minimum MAPQ required to retain fragment" />
        <param argument="--collapse_within" type="boolean" truevalue="--collapse_within" falsevalue="" label="Take cell barcode into account 
            when collapsing duplicate fragments" help="Setting this flag means that fragments with the same coordinates can be identified 
            provided they originate from a different cell barcode." />
    </inputs>
    <outputs>
        <data name='fragments' format='tabular' label="${tool.name} on ${on_string}: fragments" from_work_dir="fragments.tabular" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="bam" ftype="bam" value="aligned.bam" />
            <output name="fragments" file="fragments_default.tabular" />
        </test>
        <test expect_num_outputs="1">
            <param name="bam" ftype="bam" value="aligned.bam" />
            <param name="shift_plus" value="4" />
            <param name="shift_minus" value="5" />
            <output name="fragments" file="fragments_4_5.tabular" />
        </test>
    </tests>
    <help><![CDATA[

Sinto: single-cell analysis tools
--------------------------------------------------------------------------------------------------------------
An ATAC-seq fragment file can be created from a BAM file using the fragments command. The fragment file contains the position of each 
Tn5 integration site, the cell barcode associated with the fragment, and the number of times the fragment was sequenced. PCR duplicates are collapsed.

**Input**
A BAM file. Alignments in the input BAM file must contain cell barcodes either as a part of read names or in a tag (typically, in CB tag).

**Output**
The fragment file. It contains the positions of Tn5 integration sites, the cell barcode that the DNA fragment originated from, and the number of times 
the fragment was sequenced.

    ]]>    </help>
    <expand macro="citations" />
</tool>
