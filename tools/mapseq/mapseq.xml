<tool id="mapseq" name="MAPseq" version="2.1.1+galaxy0" profile="21.05">
    <description>fast and accurate sequence read classification tool designed to assign taxonomy and OTU classifications to ribosomal RNA sequences.</description>
    <requirements>
        <requirement type="package" version="2.1.1">mapseq</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[

        ## the DB should contain only one fasta and txt file
        #if $ref_db.db_source == "cached":
            ls -la ${ref_db.db_cached.fields.path} &&
            ln -s ${ref_db.db_cached.fields.path}/*.fasta db.fasta &&
            ln -s ${ref_db.db_cached.fields.path}/*.txt taxonomy.txt &&
            ln -s ${ref_db.db_cached.fields.path}/*.mscluster db.fasta.mscluster &&
        #else:
            ln -s ${ref_db.database} db.fasta &&
            ln -s ${ref_db.taxonomy} taxonomy.txt &&
            ln -s ${ref_db.mscluster} db.fasta.mscluster &&

        #end if

        mapseq
        -nthreads \${GALAXY_SLOTS:-8}
        -tophits '$tophits'
        -topotus '$topotus'
        -minscore '$minscore'
        -minid1 '$minid1'
        -minid2 '$minid2'
        -otulim '$otulim'
        -outfmt '$outfmt'
        '$sequences' db.fasta taxonomy.txt > '$classifications'
    ]]></command>

    <inputs>

        <param type="data" name="sequences" label="Input sequences (FASTA format)" format="fasta" />

        <conditional name="ref_db">
            <param name="db_source" type="select" label="Use cached database or database from history" help="">
                <option value="cached">Cached database</option>
                <option value="history">From history</option>
            </param>
            <when value="cached">
                <param name="db_cached" type="select" label="Using built-in mapseq DB" help="">
                    <options from_data_table="mapseq_db">
                    </options>
                    <validator type="no_options" message="A built-in mapseq DB is not available. Please ask the galaxy admins to install one on the server." />
                </param>
            </when>
            <when value="history">
                <param type="data" name="database" label="Database file (FASTA format)" format="fasta" />
                <param type="data" name="taxonomy" label="Taxonomy file" format="tabular" />
                <param type="data" name="mscluster" label="Database cluster" format="txt" optional="true" /> 
            </when>
        </conditional>
               
        <param argument="-tophits" type="integer" label="number of reference sequences to include in alignment phase" 
               value="20" help="(-tophits)" />
               
        <param argument="-topotus" type="integer" label="number of internal reference otus to include in alignment phase" 
               value="10" help="(-topotus)" />
               
        <param argument="-minscore" type="integer" label="minimum score cutoff to consider for a classification, should be reduced when searching very small sequences, i.e.: primer search" 
               value="30" help="(-minscore)" />
               
        <param argument="-minid1" type="integer" label="minimum number of shared kmers to consider hit in second phase kmer search" 
               value="1" help="(-minid1)" />
               
        <param argument="-minid2" type="integer" label="number of reference sequences to include in alignment phase" 
               value="1" help="(-minid2)" />
               
        <param argument="-otulim" type="integer" label="minimum number of shared kmers to consider hit in alignment phase" 
               value="50" help="(-otulim)" />

        <param argument="-outfmt" type="select" label="output format">
            <option value="simple">simple</option>
            <option value="confidences">confidences</option>
        </param>       
    </inputs>

    <outputs>
        <data format="tabular" name="classifications" label="Classification results"/>
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="db_source" value="history" />
            <param name="sequences" value="ERR2237853_MERGED_FASTQ.fasta"/>
            <param name="database" value="mapseq_db/LSU_trimmed.fasta"/>
            <param name="taxonomy" value="mapseq_db/slv_lsu_filtered2_trimmed.txt"/>
            <param name="mscluster" value="mapseq_db/LSU.fasta_trimmed.mscluster"/>
            <param name="minscore" value="10"/>
            <output name="classifications" file="ERR2237853_MERGED_FASTQ.mapseq" sort="true"/>
        </test>
        <test expect_num_outputs="1">
            <param name="db_source" value="history" />
            <param name="sequences" value="ERR2237853_MERGED_FASTQ.fasta"/>
            <param name="database" value="mapseq_db/LSU_trimmed.fasta"/>
            <param name="taxonomy" value="mapseq_db/slv_lsu_filtered2_trimmed.txt"/>
            <param name="minscore" value="10"/>
            <output name="classifications" file="ERR2237853_MERGED_FASTQ.mapseq" sort="true"/>
        </test>
        <test expect_num_outputs="1">
            <param name="db_source" value="cached" />
            <param name="db_cached" value="mapseq_db" />
            <param name="sequences" value="ERR2237853_MERGED_FASTQ.fasta"/>
            <param name="minscore" value="10"/>
            <output name="classifications" file="ERR2237853_MERGED_FASTQ.mapseq" sort="true"/>
        </test>
    </tests>

    <help><![CDATA[
    
MAPseq v1.2.6
by Joao F. Matias Rodrigues, Thomas S. B. Schmidt, Janko Tackmann, and Christian von Mering
Institute of Molecular Life Sciences, University of Zurich, Switzerland
Matias Rodrigues JF, Schmidt TSB, Tackmann J, and von Mering C (2017) MAPseq: highly efficient k-mer search with confidence estimates, for rRNA sequence analysis. Bioinformatics. http://doi.org/10.1093/bioinformatics/btx517

Usage:
    mapseq input.fa [<db> <tax1> <tax2> ...]

Classify a fasta file containing sequence reads to the default NCBI taxonomy and OTU classifications.
Example: mapseq -nthreads 4 rawreads.fa

Optional arguments:
           -nthreads   <int>  number of threads to use [default: 4]

Performance/sensitivity:
            -tophits   <int>  number of reference sequences to include in alignment phase [default: 20]
            -topotus   <int>  number of internal reference otus to include in alignment phase [default: 10]

Search parameters:
           -minscore   <int>  minimum score cutoff to consider for a classification, should be reduced when searching very small sequences, i.e.: primer search [default: 30]
             -minid1   <int>  minimum number of shared kmers to consider hit in second phase kmer search [default: 1]
             -minid2   <int>  minimum number of shared kmers to consider hit in alignment phase [default: 1]
             -otulim   <int>  number of sequences per internal cluster to include in alignment phase [default: 50]

Extra information:
        -print_hits          outputs list of top hits for each input sequence
        -print_align         outputs alignments

Generating count summaries from mapseq output:
          -otucounts   <sample1.mseq>
                              computes summary of classification counts from the classification output file
          -otutable   <sample1.mseq> [sample2.mseq [...]]
                              generates a tsv file with taxonomic labels as rows and samples as columns from classification output files

Report bugs to: joao.rodrigues@imls.uzh.ch
http://meringlab.org/software/mapseq/
http://github.org/jfmrod/MAPseq/


    ]]></help>

    <citations>
            <citation type="doi">
                10.1093/bioinformatics/btx517
            </citation>
    </citations>
</tool>

