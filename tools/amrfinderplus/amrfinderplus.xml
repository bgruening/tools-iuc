<tool id="amrfinderplus" name="AMRFinderPlus" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        Antimicrobial gene resistance detection
    </description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro='edam'/>
    <expand macro="requirements"/>
    <expand macro="version_command"/>

    <command detect_errors="aggressive"><![CDATA[
    echo $input_option.input_condition.input_type &&
        amrfinder
        #*======================================
                    CPU option
        ======================================*#
        --threads \${GALAXY_SLOTS:-4}
        #*======================================
                    DATABASE
        ======================================*#
        --database "$input_option.amrfinder_db_select.fields.path"
        #*======================================
                    INPUT TYPE
        ======================================*#
        $input_option.input_condition.input_type "$input_option.input_file"

        #if $input_option.input_condition.input_type == '--protein'
            $input_option.input_condition.annotation_conditionnal.annotation_select "$input_option.input_condition.annotation_conditionnal.annotation_type"
            #if $input_option.input_condition.annotation_format
                --annotation_format "$input_option.input_condition.annotation_format"
            #end if
            --protein_output "amrfinderplus_protein_output.fasta"
        #else
            --nucleotide_output "amrfinderplus_nucleotide_output.fasta"
        #end if
        #*======================================
                    ORGANISM PART
        ======================================*#
        #if $organism_options.organism_conditionnal.organism_select
            --organism "$organism_options.organism_conditionnal.organism"
            $organism_options.organism_conditionnal.mutation_all
            #if $options.plus
                $organism_options.organism_conditionnal.report_common 
            #end if
        #end if
        #*======================================
                        OPTIONS
        ======================================*#
        --ident_min "$options.ident_min"
        --coverage_min "$options.coverage_min"
        #if $options.nucleotide_flank5_size > 0
            --nucleotide_flank5_size $options.nucleotide_flank5_size
            --nucleotide_flank5_output "amrfinderplus_flanking_sequence_output.fasta"
        #end if
        #if "$options.translation_table"
            --translation_table "$options.translation_table"
        #end if
        #if $options.name
            --name $options.name
        #end if
        $options.plus
        $options.report_all_equal
        $options.print_node
        #*======================================
                        LOG OPTION
        ======================================*#
        $options.log
        --output "amrfinderplus_report.tsv"
        ]]></command>
    <inputs>
        <!-- DB and file INPUT -->
        <section name="input_option" title="Input/Output options" expanded="true">
            <param name="amrfinder_db_select" type="select" label="The amrfinderplus database">
                <options from_data_table="amrfinderplus_database">
                  <validator message="No amrfinderplus database is available" type="no_options"/>
                </options>
            </param>
            <param name="input_file" type="data" format="fasta" label="Input sequence file" help="Select the fasta file to be analyzed"/>
            <conditional name="input_condition">
                <param name="input_type" type="select" optional="false" label="Select input type format nucleotide or protein">
                    <option value="--nucleotide">Nucleotide</option>
                    <option value="--protein">Protein</option>
                </param>
                <when value="--protein">
                    <conditional name="annotation_conditionnal">
                        <param name="annotation_select" type="select" optional="true" label="Annotation format type" help="Choose to provide gff annotation file of from PGAP annotation">
                            <option value="" select="true">No GFF file</option>
                            <option value="--gff">GFF file</option>
                            <option value="--gfap">PGAP files</option>
                        </param>
                        <when value="--gff">
                            <param name="annotation_type" type="data" format="gff3" optional="true" multiple="false" label="GFF file for protein locations" help="Protein id should be in the attribute Name=id (9th field) of the rows with type CDS or gene (3rd field)"/>
                        </when>
                        <when value="--gfap">                      
                            <param name="annotation_type" type="data" format="gff3,fasta" optional="true" multiple="true" label="PGAP files" help="Select annotation files (protein, nucleotide fasta and annotation file from PGAP NCBI)"/>
                        </when>
                    </conditional>
                    <param argument="--annotation_format" type="select" optional="false" label="Annotation file format" help="Select the annotation format type (eg. bakta or prokka tool, genbank format (default: genbank)">
                        <option value="bakta">Bakta</option>
                        <option value="genbank" selected="true">Genbank</option>
                        <option value="microscope">Microscope</option>
                        <option value="patric">Patric</option>
                        <option value="pgap">PGAP</option>
                        <option value="prokka">Prokka</option>
                        <option value="pseudomonasdb">Pseudomonasdb</option>
                        <option value="rast">Rast</option>
                        <option value="standard">Standard</option>
                    </param>
                </when>
                <when value="--nucleotide">
                </when>
            </conditional>
        </section>
        <!-- ORGANISM OPTIONS -->
        <section name="organism_options" title="Organism options">
            <conditional name="organism_conditionnal">
                <param name="organism_select" type="select" label="Add organism specifications">
                    <option value="" selected="true">No specifications</option>
                    <option value="add_organism">Add organism specifications</option>
                </param>
                <when value="add_organism">
                    <param argument="--organism" type="select" optional="false" label="Taxonomy group point mutation" help="Choose a taxonomic group to point mutation screening">
                        <option value="Acinetobacter_baumannii">Acinetobacter_baumannii</option>
                        <option value="Burkholderia_cepacia">Burkholderia_cepacia</option>
                        <option value="Burkholderia_pseudomallei">Burkholderia_pseudomallei</option>
                        <option value="Campylobacter">Campylobacter</option>
                        <option value="Citrobacter_freundii">Citrobacter_freundii</option>
                        <option value="Clostridioides_difficile">Clostridioides_difficile</option>
                        <option value="Enterobacter_cloacae">Enterobacter_cloacae</option>
                        <option value="Enterococcus_faecalis">Enterococcus_faecalis</option>
                        <option value="Enterococcus_faecium">Enterococcus_faecium</option>
                        <option value="Escherichia">Escherichia</option>
                        <option value="Klebsiella_aerogenes">Klebsiella_aerogenes</option>
                        <option value="Klebsiella_oxytoca">Klebsiella_oxytoca</option>
                        <option value="Klebsiella_pneumoniae">Klebsiella_pneumoniae</option>
                        <option value="Neisseria_gonorrhoeae">Neisseria_gonorrhoeae</option>
                        <option value="Neisseria_meningitidis">Neisseria_meningitidis</option>
                        <option value="Pseudomonas_aeruginosa">Pseudomonas_aeruginosa</option>
                        <option value="Salmonella">Salmonella</option>
                        <option value="Serratia_marcescens">Serratia_marcescens</option>
                        <option value="Staphylococcus_aureus">Staphylococcus_aureus</option>
                        <option value="Staphylococcus_pseudintermedius">Staphylococcus_pseudintermedius</option>
                        <option value="Streptococcus_agalactiae">Streptococcus_agalactiae</option>
                        <option value="Streptococcus_pneumoniae">Streptococcus_pneumoniae</option>
                        <option value="Streptococcus_pyogenes">Streptococcus_pyogenes</option>
                        <option value="Vibrio_cholerae">Vibrio_cholerae</option>
                    </param>
                    <param argument="--mutation_all" type="boolean" truevalue="--mutation_all mutation_all_report.tsv" falsevalue="" label="Report genotypes at all locations screened for point mutations"/>
                    <param argument="--report_common"  type="boolean" truevalue="--report_common" falsevalue=""
                    label="Report proteins common to a taxonomy group (need the plus and organism options)"/> 
                </when>
                <when value="">
                </when>
            </conditional>
        </section>
            <!-- OPTIONS -->
        <section name="options" title="Options">
            <param argument="--ident_min" type="float" min="-1" max="1" value="-1" label="Minimum identity" 
            help="Minimum proportion of identical amino acids in alignment. -1 means use a curated threshold if it exists and 0.9 otherwise (default: -1)"/>
            <param argument="--coverage_min" type="float" min="0" max="1" value="0.5" label="Minimum coverage" 
            help="Minimum coverage of the reference protein (0 to 1, default: 0.5)"/>
            <param argument="--nucleotide_flank5_size"  type="integer" min="0" value="0" label="5' flanking sequence size"/> 
            <param argument="--translation_table"  type="select" optional="true" label="Translation table" help="NCBI genetic code for translated BLAST (default: bacterial table 11)">
                <option value="1">1 Standard code</option>
                <option value="2">2 Vertebrate mitochondrial</option>
                <option value="3">3 Yeast mitochondrial</option>
                <option value="4">4 Mold, Protozoan, and Coelenterate Mitochondrial and the Mycoplasma/Spiroplasma</option>
                <option value="5">5 Invertebrate mitochondrial</option>
                <option value="6">6 Ciliate, dasycladacean and hexamita nuclear</option>
                <option value="9">9 Echinoderm and flatworm mitochondrial</option>
                <option value="10">10 Euplotid nuclear</option>
                <option value="11" selected="true">11 Bacterial, Archaeal and Plant Plastid</option>
                <option value="12">12 Alternative yeast nuclear</option>
                <option value="13">13 Ascidian mitochondrial</option>
                <option value="14">14 Alternative flatworm mitochondrial</option>
                <option value="16">16 Chlorophycean mitochondrial</option>
                <option value="21">21 Trematode Mitochondrial</option>
                <option value="22">22 Scenedesmus obliquus Mitochondrial</option>
                <option value="23">23 Thraustochytrium Mitochondrial</option>
                <option value="24">24 Rhabdopleuridae Mitochondrial</option>
                <option value="25">25 Candidate Division SR1 and Gracilibacteria</option>
                <option value="26">26 Pachysolen tannophilus Nuclear</option>
                <option value="27">27 Karyorelict Nuclear</option>
                <option value="28">28 Condylostoma Nuclear</option>
                <option value="29">29 Mesodinium nuclear</option>
                <option value="30">30 Peritrich nuclear</option>
                <option value="31">31 Blastocrithidia nuclear</option>
                <option value="33">33 Cephalodiscidae mitochondrial</option>
            </param>
            <param argument="--plus"  type="boolean" truevalue="--plus" falsevalue="" label="Add the plus genes to the report"/>
            <param argument="--report_all_equal"  type="boolean" truevalue="--report_all_equal" falsevalue="" label="Report all equally-scoring BLAST and HMM matches"/> 
            <param argument="--print_node"  type="boolean" truevalue="--print_node" falsevalue="" label="print hierarchy node (family)"/> 
            <param argument="--name"  type="text" label="First column name" help="Text to be added as the first column 'name' to all rows of the report"/> 
            <param argument="--log"  type="boolean" truevalue="--log amrfinderplus.log" falsevalue="" label="Add a log file"/> 
        </section>
    </inputs>
    <outputs>
        <data name="amrfinderplus_report" format="tabular" from_work_dir="amrfinderplus_report.tsv" label="${tool.name} on ${on_string}: AMRFinderPlus report"/>
        <data name="mutation_all_report" format="tabular" from_work_dir="mutation_all_report.tsv" label="${tool.name} on ${on_string}: Point mutation report">
            <filter> organism_options['organism_conditionnal']['organism_select'] == "add_organism" and organism_options['organism_conditionnal']['mutation_all'] is True  </filter>
        </data>
        <data name="protein_output" format="fasta" from_work_dir="amrfinderplus_protein_output.fasta" label="${tool.name} on ${on_string}: Protein identified sequences">
            <filter> input_option['input_condition']['input_type'] == "--protein" </filter>
        </data>
        <data name="nucleotide_output" format="fasta" from_work_dir="amrfinderplus_nucleotide_output.fasta" label="${tool.name} on ${on_string}: Nucleotide identified sequences">
            <filter> input_option['input_condition']['input_type'] == "--nucleotide" </filter>
        </data>
        <data name="nucleotide_flank5_output" format="fasta" from_work_dir="amrfinderplus_flanking_sequence_output.fasta" 
        label="${tool.name} on ${on_string}: Nucleotide sequences with 5' flanking regions">
            <filter> options['nucleotide_flank5_size'] !=0 </filter>
        </data>
        <data name="logfile" format="txt"  from_work_dir="amrfinderplus.log" label="${tool.name} on ${on_string}: log file">
            <filter> options['log'] is True </filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2"> <!-- TEST_1 just simple nucleotide input   -->
            <section name="input_option">
                <param name="amrfinder_db_select" value="V3.11.1-2023-04-17.1"/>
                <param name="input_file" value="enterococcus_faecalis.fna"/>
                <conditional name="input_condition">
                    <param name="input_type" value="--nucleotide"/>
                </conditional>
            </section>
            <output name="amrfinderplus_report" value="test_1/amrfinderplus_results.tsv" ftype="tabular" lines_diff="1"/>
            <output name="nucleotide_output" value="test_1/amrfinderplus_nucleotide_output.fasta" ftype="fasta" lines_diff="1"/>
        </test>    
        <test expect_num_outputs="5"> <!-- TEST_2 nucleotide input and full options  -->
            <section name="input_option">
                <param name="amrfinder_db_select" value="V3.11.1-2023-04-17.1"/>
                <param name="input_file" value="enterococcus_faecalis.fna"/>
                <conditional name="input_condition">
                    <param name="input_type" value="--nucleotide"/>
                </conditional>
            </section>
            <section name="organism_options">
                <conditional name="organism_conditionnal">
                    <param name="organism_select" value="add_organism"/>
                    <param name="organism" value="Enterococcus_faecalis"/>
                    <param name="mutation_all" value="true"/>
                    <param name="report_common" value="true"/>
                </conditional>
            </section>
            <section name="options">
                <param name="ident_min" value="1"/>
                <param name="coverage_min" value="0.1"/>
                <param name="nucleotide_flank5_size" value="150"/>
                <param name="translation_table"  value="11"/>
                <param name="plus" value="boolean"/>
                <param name="report_all_equal" value="true"/>
                <param name="print_node" value="true"/>
                <param name="name" value="test_2"/>
                <param name="log" value="true"/>
            </section>
            <output name="amrfinderplus_report" value="test_2/amrfinderplus_results.tsv" ftype="tabular" lines_diff="1"/>
            <output name="mutation_all_report" value="test_2/amrfinderplus_mutation_all.tsv" ftype="tabular" lines_diff="1"/>
            <output name="nucleotide_output" value="test_2/amrfinderplus_nucleotide_output.fasta" ftype="fasta" lines_diff="1"/>
            <output name="nucleotide_flank5_output" value="test_2/amrfinderplus_flanking_output.fasta" ftype="fasta" lines_diff="1"/>
            <output name="logfile" value="test_2/amrfinderplus.log" ftype="txt">
                <assert_contents>
                    <has_n_lines n="13"/>
                </assert_contents>
            </output>
        </test>    
        <test expect_num_outputs="2"> <!-- TEST_3 nucleotide input and several options  -->
            <section name="input_option">
                <param name="amrfinder_db_select" value="V3.11.1-2023-04-17.1"/>
                <param name="input_file" value="enterococcus_faecalis.fna"/>
                <conditional name="input_condition">
                    <param name="input_type" value="--nucleotide"/>
                </conditional>
            </section>
            <section name="organism_options">
                <conditional name="organism_conditionnal">
                    <param name="organism_select" value="add_organism"/>
                    <param name="organism" value="Enterococcus_faecalis"/>
                    <param name="report_common" value="true"/>
                </conditional>
            </section>
            <section name="options">
                <param name="report_all_equal" value="true"/>
            </section>
            <output name="amrfinderplus_report" value="test_3/amrfinderplus_results.tsv" ftype="tabular" lines_diff="1"/>
            <output name="nucleotide_output" value="test_3/amrfinderplus_nucleotide_output.fasta" ftype="fasta" lines_diff="1"/>
        </test>    
        <test expect_num_outputs="2"> <!-- TEST_4 protein input and several options  -->
            <section name="input_option">
                <param name="amrfinder_db_select" value="V3.11.1-2023-04-17.1"/>
                <param name="input_file" value="enterococcus_faecalis.faa"/>
                <conditional name="input_condition">
                    <param name="input_type" value="--protein"/>
                </conditional>
            </section>
            <output name="amrfinderplus_report" value="test_4/amrfinderplus_results.tsv" ftype="tabular" lines_diff="1"/>
            <output name="protein_output" value="test_4/amrfinderplus_protein_output.fasta" ftype="fasta" lines_diff="1"/>
        </test>    
        <test expect_num_outputs="2"> <!-- TEST_5 protein input and full options for gff3 and bakta  -->
            <section name="input_option">
                <param name="amrfinder_db_select" value="V3.11.1-2023-04-17.1"/>
                <param name="input_file" value="enterococcus_faecalis.faa"/>
                <conditional name="input_condition">
                    <param name="input_type" value="--protein"/>
                    <conditional name="annotation_conditionnal">
                        <param name="annotation_select" value="--gff"/>
                        <param name="annotation_type" value="enterococcus_faecalis_bakta.gff3"/>
                    </conditional>
                    <param argument="annotation_format" value="bakta"/>
                </conditional>
            </section>
            <section name="organism_options">
                <conditional name="organism_conditionnal">
                    <param name="organism_select" value="add_organism"/>
                    <param name="organism" value="Enterococcus_faecalis"/>
                    <param name="mutation_all" value="true"/>
                    <param name="report_common" value="true"/>
                </conditional>
            </section>
            <section name="options">
                <param name="ident_min" value="0.1"/>
                <param name="coverage_min" value="0.4"/>
                <param name="nucleotide_flank5_size" value="150"/> 
                <param name="translation_table" value="11"/>
                <param name="plus" value="true"/>
                <param name="report_all_equal" value="true"/> 
                <param name="print_node" value="true"/> 
                <param name="name" value="test_5"/> 
            </section>
            <output name="amrfinderplus_report" value="test_5/amrfinderplus_results.tsv" ftype="tabular" lines_diff="1"/>
            <output name="mutation_all_report" value="test_5/amrfinderplus_mutation_all.tsv" ftype="tabular" lines_diff="1"/>
            <output name="protein_output" value="test_5/amrfinderplus_nucleotide_output.fasta" ftype="fasta" lines_diff="1"/>
            <output name="nucleotide_flank5_output" value="test_5/amrfinderplus_flanking_output.fasta" ftype="fasta" lines_diff="1"/>
        </test>    
    </tests>
    <help><![CDATA[**What it does**
        devfvsrv
        zsvsrevre
    ]]></help>
    <expand macro="citations"/>
</tool>
