<tool id="bff_validator" name="BFF Validator" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>A script that validates metadata (XLSX|JSON) against Beacon v2 Models and serializes it to BFF (JSON)</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[   
        #if str($bff_input.input_bff_file) == "json":
            #import re
            #set $names = []
            #set $x=1
            #for $x, $i in enumerate($bff_input.input):
                #set $name_base = re.sub('[^\w\-_\.]', '_', $i.element_identifier)
                #set $name = $name_base
                #silent $names.append( $name )
                ln -s '$i' ${name}  &&
            #end for
        #end if
        #if str($bff_input.input_bff_file) == "xlsx":
            ln -s '$bff_input.input' ./input.xlsx &&
        #end if
        ln -s '$schema_dir' ./schema_dir &&
        bff-validator
            #if str($bff_input.input_bff_file) == "json":
                #for $name in $names:
                    --input ${name}
                #end for
                #if str($bff_input.genomicVariations.genomicVariations_avail) == "yes":    
                    $bff_input.genomicVariations.gv
                #end if
                $bff_input.ignore_validation
            #end if
            #if str($bff_input.input_bff_file) == "xlsx":
                --input ./input.xlsx
                --out-dir ./
            #end if
            --schema-dir ./schema_dir
            > '$validate_bff_files'
    ]]></command>
    <inputs>
        <conditional name="bff_input">
            <param name="input_bff_file" type="select" label="Type of bff file" help="">
                <option value="xlsx" selected="True">Build a new copy number reference file</option>
                <option value="json">Reuse a copy number reference file</option>
            </param>
            <when value="xlsx">
                <param argument="--input" type="data" format="xlsx" label="Metadata xlsx file" help="" />
            </when>
            <when value="json">
                <param argument="--input" type="data" multiple="true" format="json" label="Json files" help="" />
                <conditional name="genomicVariations">
                    <param name="genomicVariations_avail" type="select" label="Do you have genomicVariations.json file withen your data" help="">
                        <option value="yes" selected="True">Build a new copy number reference file</option>
                        <option value="no">Reuse a copy number reference file</option>
                    </param>
                    <when value="yes">
                        <param argument="-gv" type="boolean" checked="false" truevalue="-gv" falsevalue="" label="process genomicVariations.json entity" help="" />
                    </when>
                    <when value="no">
                    </when>
                </conditional>
                <param argument="--ignore-validation" type="boolean" checked="false" truevalue="--ignore-validation" falsevalue="" label="Ignore validation" help="Writes JSON collection regardless of results from validation against JSON schemas" />
            </when>
        </conditional>
        <param argument="--schema-dir" type="data" format="directory" multiple="true" label="Directory with JSON schemas" help="Must have JSON pointers de-referenced" />
    </inputs>
    <outputs>
        <data name="validate_bff_files" format="txt" label="${tool.name} on ${on_string}: validate_bff_files results" from_work_dir="bff_validation.text" />
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input_bff_file" value="json" />
            <param name="input" ftype="json" value="runs.json,individuals.json" />
            <param name="schema_dir" ftype="json" value="deref_schemas" />
            <output name="validate_bff_files" file="bff_validation.text" compare="sim_size">
                <assert_contents><has_size value="1000" delta="100" /></assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
           A script that validates metadata (XLSX|JSON) against Beacon v2 Models and serializes it to BFF (JSON)
    ]]></help>
    <expand macro="citations" />
</tool>
